# Afena Nexus — Development Notes

> Codebase screening results for placeholders, TODOs, stubs, and incomplete implementations.

---

## Completed Items (2026-02-12)

### 1. ~~Placeholder Tests~~ → ✅ Implemented

- `packages/database/src/__tests__/jwt-org-claim.test.ts`:
  - Real integration tests gated by `RUN_JWT_TESTS=1`
  - `decodeJwtPayload` helper with unit tests
  - Tests: setActive claim, org switching, RLS rejection (INVARIANT-12)

### 2. ~~Placeholder Policy Implementation~~ → ✅ Implemented

- `packages/crud/src/policy.ts`:
  - Full RBAC hard gate (INVARIANT-07) with `POLICY_DENIED` error code
  - Authority snapshot with normalized + raw roles
  - Action family mapping via `getActionFamily()` from canon
  - Tests in `packages/crud/src/__tests__/policy.test.ts`

### 3. ~~Deprecated Feature Warning~~ → ✅ Removed

- `tools/afena-cli/src/index.ts`:
  - `--fix-readmes` option and shim block removed

### 4. ~~Workflow DB Rules~~ → ✅ Implemented

- `packages/database/src/schema/workflow-rules.ts`: new table with typed array defaults, CHECK constraints, RLS
- `packages/workflow/src/interpreter.ts`: JSON → ConditionFn/ActionFn interpreter
- `packages/workflow/src/db-loader.ts`: per-org TTL-cached rule loader
- `packages/workflow/src/registry.ts`: `unregisterByPrefix()` helper
- Tests in `packages/workflow/src/__tests__/interpreter.test.ts`
- Wired into `mutate.ts` between `enforcePolicy` and `evaluateRules`

### 5. ~~orgId + roles stub~~ → ✅ Populated

- `apps/web/app/actions/contacts.ts`:
  - `buildContext()` now queries `auth.org_id()` + `auth.org_role()` from DB
  - Populates `ctx.actor.orgId` and `ctx.actor.roles` for RBAC + workflow loader

### 6. **OPS-CHECKLIST.md** → ✅ Created

- Pre-production ops checklist at repo root

---

## Remaining Items (not blockers):

- `.agent/reference/next.js/authentication.md`: Two `// TODO:` comments (reference docs, not production code)
- `packages/canon/src/types/action.ts`: "Phase 1 action types — contacts only" (will expand with new entities)
- `packages/database/scripts/create-auth-org-helpers.sql`: "Future-proof: tries camelCase then snake_case" (documentation, working as intended)

---

_Updated: 2026-02-12_
