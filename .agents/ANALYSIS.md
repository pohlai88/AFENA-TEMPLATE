# .agent Directory Analysis & Recommendations

**Analysis Date:** February 17, 2026  
**Status:** Migration from axis-erp/ERPNext to AFENDA-NEXUS complete

---

## Executive Summary

The `.agent` directory contains **legacy content** from the previous "axis-erp" and "ERPNext" refactor phases. The project has evolved into **AFENDA-NEXUS**, a clean monorepo architecture with 18 packages across 4 layers.

**Recommended Actions:**

1. ‚úÖ Remove 3 legacy plans (axis-erp/ERPNext references)
2. ‚úÖ Remove 1 legacy rule (axis-erp-test-location)
3. ‚úÖ Archive 1 outdated context file
4. ‚úÖ Create 5 new essential skills for AFENDA-NEXUS
5. ‚úÖ Update existing skills to match current architecture

---

## 1. LEGACY CONTENT TO REMOVE

### Plans (Remove 3/5)

#### ‚ùå **erp.full.refactor.md** (1031 lines)

- **Status:** LEGACY - References axis-erp compiler pipeline
- **Why Remove:**
  - References "511 LocalEntitySpec in axis-erp" (archived)
  - Discusses "HandlerAdapter" and "SchemaAdapter" (pre-AFENDA architecture)
  - Entity adoption is already complete (Setup 27/27, Projects 13/14)
- **Action:** Move to ARCHIVE/docs/

#### ‚ùå **setup-domain-remaining-emit.md** (233 lines)

- **Status:** LEGACY - Pre-AFENDA compliance fixes
- **Why Remove:**
  - References axis-erp/AGENT.md and module-structure.md (archived)
  - File naming issues already resolved in AFENDA-NEXUS
  - Setup domain adoption is complete (27/27 entities)
- **Action:** Move to ARCHIVE/docs/

#### ‚ùå **ERPNext_Refactor_Guide.md** (601 lines)

- **Status:** LEGACY - Pre-AFENDA implementation guide
- **Why Remove:**
  - References axis-erp adapter pipeline (deprecated)
  - Adoption workflow is complete
  - Commands reference outdated tooling
- **Action:** Move to ARCHIVE/docs/

#### ‚úÖ **PROJECTS_DOMAIN_ADOPTION_STRATEGY.md** (Keep & Archive)

- **Status:** REFERENCE - Complete implementation record
- **Why Keep:** Historical record of Projects domain completion (13/14 entities)
- **Action:** Keep for reference but move to context/ with note that work is complete

#### ‚úÖ **SETUP_DOMAIN_ADOPTION_STRATEGY.md** (Keep & Archive)

- **Status:** REFERENCE - Complete implementation record
- **Why Keep:** Historical record of Setup domain completion (27/27 entities)
- **Action:** Keep for reference but move to context/ with note that work is complete

### Rules (Remove 1/3)

#### ‚ùå **axis-erp-test-location.mdc**

- **Status:** LEGACY - References archived axis-erp structure
- **Why Remove:**
  - References `axis-erp/__tests__/` (no longer exists)
  - References `axis-erp/AGENT.md` (archived)
  - Current structure uses `packages/*/src/**/*.test.ts` pattern
- **Action:** Remove (test conventions in ARCHITECTURE.md)

#### ‚úÖ **neon-drizzle.mdc** (Keep)

- **Status:** ACTIVE - Still applicable
- **Why Keep:** Database patterns still used in AFENDA-NEXUS

#### ‚úÖ **vitest-mcp.mdc** (Keep)

- **Status:** ACTIVE - Still applicable
- **Why Keep:** Testing strategy still valid

### Context (Archive 1/1)

#### üîÑ **capability-map.md** (Archive)

- **Status:** OUTDATED - Auto-generated, references old entities
- **Why Archive:**
  - Auto-generated by `afenda meta gen` (can be regenerated)
  - References contacts/companies (CRM Phase 1)
  - Missing newer entities (inventory, accounting, etc.)
- **Action:** Regenerate with current entity set or remove if not actively used

---

## 2. REQUIRED NEW SKILLS

### Priority 1: Core Development Skills

#### 1. **afenda-architecture** ‚≠ê‚≠ê‚≠ê

**Description:** AFENDA-NEXUS monorepo architecture, layered dependencies, and package structure

**Why Needed:**

- Current team needs guidance on 4-layer architecture
- Dependency rules frequently questioned
- New packages need proper layer placement

**Content:**

- 4-layer architecture (Layer 0-3)
- Dependency flow rules (bottom-up only)
- Package creation guidelines
- Circular dependency prevention
- When to split packages

**References:**

- [ARCHITECTURE.md](../ARCHITECTURE.md)
- [packages/GOVERNANCE.md](../packages/GOVERNANCE.md)
- Layer dependency validator tool

---

#### 2. **afena-cli-usage** ‚≠ê‚≠ê‚≠ê

**Description:** afenda CLI tool usage for code generation, validation, and monorepo management

**Why Needed:**

- CLI has 20+ commands but no consolidated guide
- New developers struggle with meta commands
- Adapter pipeline needs explanation

**Content:**

- Core commands (`afenda meta`, `afenda housekeeping`, `afenda bundle`)
- Adapter pipeline (`emit-all`, `handler-emit`, `bff-emit`)
- Validation commands (`schema-validate`, `type-check:refs`)
- Common workflows (add entity, validate deps, generate docs)

**References:**

- `tools/afena-cli/` source
- `package.json` scripts
- Existing adapter documentation

---

#### 3. **afenda-database-patterns** ‚≠ê‚≠ê

**Description:** Database schema patterns, migrations, RLS, and Drizzle ORM usage in AFENDA-NEXUS

**Why Needed:**

- 72 migrations with specific patterns
- RLS on all tables (multi-tenancy)
- Composite PKs, FK constraints, unique constraints
- Migration best practices needed

**Content:**

- Migration file structure
- RLS policy patterns
- Drizzle schema conventions
- Composite primary keys
- FK constraint patterns
- Common migration operations

**References:**

- `packages/database/src/migrations/`
- `packages/database/src/schema/`
- Neon Postgres integration
- Multi-tenancy patterns

---

#### 4. **package-development** ‚≠ê‚≠ê

**Description:** Creating, structuring, and maintaining packages in the AFENDA-NEXUS monorepo

**Why Needed:**

- 18 packages with varying structures
- Layer-specific requirements
- Export patterns need standardization
- Testing conventions per package type

**Content:**

- Package structure templates (Layer 0, 1, 2, 3)
- Required files (package.json, tsconfig.json, README.md)
- Export patterns (barrel exports, public API)
- Testing setup per layer
- Build configuration
- Documentation requirements

**References:**

- [packages/PACKAGE_TEMPLATE.md](../packages/PACKAGE_TEMPLATE.md)
- [packages/GOVERNANCE.md](../packages/GOVERNANCE.md)
- Existing package structures

---

#### 5. **domain-driven-patterns** ‚≠ê

**Description:** Domain-driven design patterns used in AFENDA-NEXUS domain packages

**Why Needed:**

- Domain packages (accounting, inventory, crm) follow DDD
- Services, policies, ports, value objects patterns
- Dependency injection via constructor
- Immutable value objects

**Content:**

- Service pattern (business logic)
- Policy pattern (class + ports)
- Port pattern (interfaces, no I prefix)
- Value object pattern (immutable, static create)
- Repository pattern
- Domain event pattern

**References:**

- Domain packages (accounting, inventory, crm)
- Existing service implementations
- Policy implementations

---

### Priority 2: Operations & Quality

#### 6. **monorepo-testing-strategy** ‚≠ê

**Description:** Testing strategy across the monorepo (unit, integration, E2E)

**Why Needed:**

- Multiple test types (Vitest unit, Vitest integration, Playwright E2E)
- Coverage requirements
- Test organization
- MCP integration for AI-powered testing

**Content:**

- Unit test patterns (per package)
- Integration test patterns (database transactions)
- E2E test patterns (Playwright)
- Coverage requirements (80% for packages)
- Test organization conventions
- MCP usage for test generation

**References:**

- Existing vitest-testing skill (update)
- `vitest.config.ts`
- `playwright.config.ts`
- Package test suites

---

#### 7. **ci-cd-pipeline** ‚≠ê

**Description:** GitHub Actions CI/CD pipeline, security scanning, and deployment

**Why Needed:**

- CI pipeline has lint, test, audit, SBOM, E2E
- Renovate auto-updates
- Security scanning needs documentation
- Deployment process

**Content:**

- GitHub Actions workflows
- Lint and type-check in CI
- Test execution (unit + E2E)
- Security audit and SBOM generation
- Renovate configuration
- Deployment to Vercel

**References:**

- `.github/workflows/`
- `renovate.json5`
- Security stack documentation

---

## 3. SKILLS TO UPDATE

### Update: **lint-types-debug**

**Current:** 374 lines, comprehensive  
**Action:** Update package names (no longer axis-erp references)  
**Changes:**

- Update examples to use `afenda-*` package names
- Add references to Layer dependency errors
- Include composite project (tsc -b) guidance

### Update: **neon-postgres**

**Current:** Complete with 28 references  
**Action:** Add AFENDA-specific patterns  
**Changes:**

- Add RLS examples from afenda-database
- Add migration patterns
- Add composite PK examples

### Update: **vitest-testing**

**Current:** Good foundation  
**Action:** Add AFENDA-specific patterns  
**Changes:**

- Add domain package testing patterns
- Add multi-package integration tests
- Add MCP usage for domain logic testing

---

## 4. RECOMMENDED DIRECTORY STRUCTURE

```
.agents/                                # SSOT for agent resources
‚îú‚îÄ‚îÄ README.md                           # Updated overview
‚îú‚îÄ‚îÄ INDEX.md                            # Updated index
‚îú‚îÄ‚îÄ ANALYSIS.md                         # This file
‚îÇ
‚îú‚îÄ‚îÄ context/                            # Reference materials
‚îÇ   ‚îú‚îÄ‚îÄ PROJECTS_DOMAIN_COMPLETE.md     # Moved from plans/ (reference)
‚îÇ   ‚îú‚îÄ‚îÄ SETUP_DOMAIN_COMPLETE.md        # Moved from plans/ (reference)
‚îÇ   ‚îî‚îÄ‚îÄ capability-map.md               # Keep or regenerate
‚îÇ
‚îú‚îÄ‚îÄ skills/                             # Active skills
‚îÇ   ‚îú‚îÄ‚îÄ SKILL-TEMPLATE.md
‚îÇ   ‚îú‚îÄ‚îÄ afenda-architecture/            # NEW - Priority 1
‚îÇ   ‚îú‚îÄ‚îÄ afena-cli-usage/               # NEW - Priority 1
‚îÇ   ‚îú‚îÄ‚îÄ afenda-database-patterns/       # NEW - Priority 1
‚îÇ   ‚îú‚îÄ‚îÄ package-development/            # NEW - Priority 1
‚îÇ   ‚îú‚îÄ‚îÄ domain-driven-patterns/         # NEW - Priority 2
‚îÇ   ‚îú‚îÄ‚îÄ monorepo-testing-strategy/      # NEW - Priority 2
‚îÇ   ‚îú‚îÄ‚îÄ ci-cd-pipeline/                 # NEW - Priority 2
‚îÇ   ‚îú‚îÄ‚îÄ lint-types-debug/               # UPDATE
‚îÇ   ‚îú‚îÄ‚îÄ neon-postgres/                  # UPDATE
‚îÇ   ‚îú‚îÄ‚îÄ vitest-testing/                 # UPDATE
‚îÇ   ‚îî‚îÄ‚îÄ example-deployment/             # Keep as-is
‚îÇ
‚îî‚îÄ‚îÄ rules/                              # Active rules
    ‚îú‚îÄ‚îÄ neon-drizzle.mdc                # Keep
    ‚îî‚îÄ‚îÄ vitest-mcp.mdc                  # Keep
```

**Removed:**

- `plans/` directory (all content legacy or moved to context)
- `rules/axis-erp-test-location.mdc` (legacy)

---

## 5. IMPLEMENTATION PLAN

### Phase 1: Cleanup (1 hour)

1. Move 3 legacy plans to `ARCHIVE/docs/legacy-plans/`
2. Move 2 completed strategies to `.agents/context/` with completion note
3. Remove `axis-erp-test-location.mdc`
4. Regenerate or remove `capability-map.md`
5. Update INDEX.md and README.md

### Phase 2: Create Priority 1 Skills (4-6 hours)

1. **afenda-architecture** - Extract from ARCHITECTURE.md + GOVERNANCE.md
2. **afena-cli-usage** - Document CLI commands and workflows
3. **afenda-database-patterns** - Extract from migrations and schema
4. **package-development** - Create from PACKAGE_TEMPLATE + examples

### Phase 3: Create Priority 2 Skills (3-4 hours)

1. **domain-driven-patterns** - Extract from domain packages
2. **monorepo-testing-strategy** - Consolidate testing docs
3. **ci-cd-pipeline** - Document GitHub Actions workflows

### Phase 4: Update Existing Skills (2-3 hours)

1. Update lint-types-debug with AFENDA references
2. Enhance neon-postgres with RLS and migration patterns
3. Enhance vitest-testing with domain testing patterns

---

## 6. SUCCESS METRICS

**After Cleanup:**

- ‚úÖ Zero references to "axis-erp" in .agents/
- ‚úÖ Zero references to "ERPNext refactor" in active content
- ‚úÖ All active content references AFENDA-NEXUS packages
- ‚úÖ Directory structure matches current architecture

**After Skill Creation:**

- ‚úÖ New developers can navigate 4-layer architecture
- ‚úÖ CLI usage is documented and searchable
- ‚úÖ Database patterns are standardized
- ‚úÖ Package creation follows template
- ‚úÖ DDD patterns are consistent across domains

---

## 7. MAINTENANCE GOING FORWARD

### When to Update Skills:

- Architecture changes (new layer, dependency changes)
- CLI command additions
- New database patterns emerge
- Testing strategy evolves

### When to Add New Skills:

- New major feature (e.g., async jobs, event sourcing)
- New tooling integration
- Cross-cutting concerns emerge

### When to Archive Skills:

- Technology replaced
- Patterns deprecated
- Content becomes legacy

---

## Appendix: Current State Analysis

### Packages (18 total)

**Layer 0 (Config):** eslint-config, typescript-config  
**Layer 1 (Foundation):** canon, database, logger, ui  
**Layer 2 (Domain):** accounting, advisory, crm, intercompany, inventory, migration, procurement, purchasing, search, workflow  
**Layer 3 (Application):** crud, observability

### Entity Adoption Complete

- Setup domain: 27/27 entities (100%)
- Projects domain: 13/14 entities (93%, 1 locked)
- Total migrations: 72 (0000-0072)

### Test Coverage

- Unit tests: Vitest across all packages
- Integration tests: Database transactions
- E2E tests: Playwright (19 tests, 6 files)
- Coverage target: 80% per package

### Architecture Compliance

- Zero circular dependencies ‚úÖ
- Layer rules enforced ‚úÖ
- Dependency validator in CI ‚úÖ
- TypeScript strict mode ‚úÖ

---

**End of Analysis**
