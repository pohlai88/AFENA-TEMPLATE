<!-- AUTOGEN:START -->
<!-- Generated by afenda readme gen ‚Äî DO NOT EDIT inside this block -->
<!-- Signature: sha256:ec866292e768284a569a6233c6bd0809af55230d21c16f0428a6209f51a5ae04 -->
# afenda-database

Package providing **helper functions**. Import from `afenda-database` in workspace packages.

## Package Overview

‚úÖ Has Tests ‚Ä¢ üìÅ 10 directory areas

### What's Inside

- **Helper functions**
- **Main exports (barrel from index)**
- **Schemas (DB or validation)**
- **Scripts and tooling**
- **Type definitions and shared interfaces**

### Directory Structure

```
‚îú‚îÄ‚îÄ src/
    ‚îú‚îÄ‚îÄ __tests__/ (5 files)
    ‚îú‚îÄ‚îÄ ddl/ (2 files)
    ‚îú‚îÄ‚îÄ helpers/ ‚Äî Helper functions (12 files)
    ‚îú‚îÄ‚îÄ observability/ (2 files)
    ‚îú‚îÄ‚îÄ query-plan/ (1 file)
    ‚îú‚îÄ‚îÄ schema/ ‚Äî Database or validation schemas (161 files)
    ‚îú‚îÄ‚îÄ scripts/ ‚Äî Build or runtime scripts (17 files)
    ‚îî‚îÄ‚îÄ types/ ‚Äî Type definitions and shared interfaces (1 file)
‚îî‚îÄ‚îÄ scripts/ ‚Äî Build or runtime scripts (17 files)
```

### Source Layout

- **`helpers/`** ‚Äî Helper functions
- **`schema/`** ‚Äî Database or validation schemas
- **`scripts/`** ‚Äî Build or runtime scripts
- **`types/`** ‚Äî Type definitions and shared interfaces

### Entry Points

- `src/index.ts` ‚Äî barrel export
- `src/schema/index.ts` ‚Äî barrel export

## Usage

```ts
import { /* ... */ } from 'afenda-database';
```

This package exposes:

- Helper functions
- Main exports (barrel from index)
- Schemas (DB or validation)
- Scripts and tooling
- Type definitions and shared interfaces

## API

See `src/index.ts` and subpaths for full exports.

## Installation

```bash
pnpm -w add afenda-database
```

## Exports

| Subpath | Conditions |
|---|---|
| `.` | default: `./src/index.ts` |

## Scripts

| Script | Command |
|---|---|
| `build` | `tsup` |
| `build:measure` | `node scripts/measure-build-time.mjs` |
| `db:bootstrap` | `node scripts/bootstrap-neon.mjs` |
| `db:check` | `drizzle-kit check` |
| `db:drizzle:ci` | `node scripts/drizzle-migration-ci.mjs` |
| `db:drizzle:neon-guard` | `node scripts/drizzle-neon-guard.mjs` |
| `db:export` | `drizzle-kit export --config=drizzle.ci.config.ts` |
| `db:generate` | `drizzle-kit generate` |
| `db:lint` | `npx tsx src/scripts/schema-lint.ts` |
| `db:migrate` | `node scripts/run-migrate.mjs` |
| `db:migrate:kit` | `drizzle-kit migrate` |
| `db:patch-migration-triggers` | `node scripts/patch-migration-triggers.mjs` |
| `db:push` | `drizzle-kit push` |
| `db:studio` | `drizzle-kit studio` |
| `db:validate-gates` | `npx tsx scripts/validate-gates.ts` |
| `db:validate-migration` | `npx tsx scripts/validate-migration-safety.ts` |
| `db:validate-query-plans` | `npx tsx scripts/validate-query-plans.ts` |
| `db:validate-registry` | `npx tsx scripts/validate-registry.ts` |
| `dev` | `tsup --watch` |
| `lint` | `eslint . --ext .js,.jsx,.ts,.tsx --cache` |
| `lint:fix` | `eslint . --ext .js,.jsx,.ts,.tsx --fix` |
| `type-check` | `tsc --noEmit` |

## Architecture

Source is organized by responsibility. Key areas:

- **`src/helpers/`** ‚Äî Helper functions
- **`src/schema/`** ‚Äî Database or validation schemas
- **`src/scripts/`** ‚Äî Build or runtime scripts
- **`src/types/`** ‚Äî Type definitions and shared interfaces
- **`scripts/`** ‚Äî Build or runtime scripts
- **`src/index.ts`** ‚Äî Public API barrel

## Dependencies

| Package | Version |
|---|---|
| `@neondatabase/serverless` | `catalog:` |
| `drizzle-orm` | `catalog:` |

## Related Packages

- `afenda-eslint-config`
- `afenda-typescript-config`

## Contributing

### Development Workflow

1. Make changes to source files
2. Run `pnpm lint:fix` to fix linting issues
3. Run `pnpm type-check` to verify types
4. Run `pnpm test` to verify tests pass
5. Run `pnpm build` to verify build succeeds

### Code Quality

- All code must pass ESLint checks
- All code must pass TypeScript type checking
- All tests must pass
- Maintain or improve test coverage

<!-- AUTOGEN:END -->

# afenda-database

**Layer 1 ¬∑ Foundation** ‚Äî Drizzle ORM schemas, DbSession primitive, multi-tenant isolation & query observability for AFENDA-NEXUS.

**Architecture Version:** 3.1 (Canon DB Integration)

---

## Architecture Role

```
Layer 3  Application    (crud, observability)
Layer 2  Domain Services (workflow, 116 business-domain packages)
Layer 1  Foundation      (canon, database ‚Üê YOU ARE HERE, logger, ui)
Layer 0  Configuration   (eslint-config, typescript-config)
```

This package is the **single source of truth** for database schema definitions and access primitives.
It contains **zero business logic** ‚Äî schemas only, no calculations, no orchestration.

---

## What's Inside

```
packages/database/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts              # Public API barrel ‚Äî the only import target
‚îÇ   ‚îú‚îÄ‚îÄ db.ts                 # Neon RW/RO Drizzle instances
‚îÇ   ‚îú‚îÄ‚îÄ db-session.ts         # DbSession primitive (single DB entrypoint)
‚îÇ   ‚îú‚îÄ‚îÄ auth-context.ts       # RLS auth context (set_context / validate)
‚îÇ   ‚îú‚îÄ‚îÄ schema/               # 160 table schemas + barrel + registry
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ index.ts          # Barrel re-exports every schema + types
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ _registry.ts      # Table taxonomy & mechanical validation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ relations.ts      # Drizzle relational mappings
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ *.ts              # One file per table
‚îÇ   ‚îú‚îÄ‚îÄ helpers/              # Schema building blocks
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base-entity.ts    # baseEntityColumns (id, org_id, timestamps, version, soft-delete)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ erp-entity.ts     # erpEntityColumns (+ companyId, siteId, customData)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ doc-entity.ts     # docEntityColumns (+ docStatus lifecycle)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ doc-status.ts     # docStatusEnum pg enum
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ field-types.ts    # moneyMinor, currencyCode, currencyCodeStrict, fxRate, qty, etc.
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tenant-pk.ts      # tenantPk, tenantFk, tenantFkPattern, tenantFkIndex
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tenant-policy.ts  # tenantPolicy, ownerPolicy (Neon crudPolicy RLS)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ standard-indexes.ts  # erpIndexes, docIndexes (PK + indexes + CHECK + RLS)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ natural-key-immutability.ts  # NK trigger SQL generator + NK_TABLES registry
‚îÇ   ‚îú‚îÄ‚îÄ ddl/                  # Safe DDL generation for migrations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ident.ts          # qIdent, qSchemaIdent, sanitizeIdent
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rls.ts            # tenantPolicySql, evidenceRlsSetup, etc.
‚îÇ   ‚îú‚îÄ‚îÄ observability/        # Query monitoring
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ query-monitor.ts  # Slow-query logging, shape-tagged monitoring
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ query-shapes.ts   # QUERY_SHAPES registry, hot-path identification
‚îÇ   ‚îú‚îÄ‚îÄ query-plan/           # PLAN-01 gate
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ analyzer.ts       # validateQueryPlan, seq-scan / tenant checks
‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ session.ts        # AuthContext, DbSession, DbOrTransaction
‚îÇ   ‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ schema-lint.ts    # 8-rule schema linter (pnpm db:lint)
‚îÇ   ‚îî‚îÄ‚îÄ __tests__/
‚îú‚îÄ‚îÄ scripts/                  # CI validation scripts
‚îÇ   ‚îú‚îÄ‚îÄ bootstrap-neon.mjs          # Programmatic bootstrap runner
‚îÇ   ‚îú‚îÄ‚îÄ bootstrap-neon.sql          # Idempotent DB prerequisite creation
‚îÇ   ‚îú‚îÄ‚îÄ drizzle-migration-ci.mjs    # 8 offline CI gates (MIG-DRZ-01..04, Gate A/B)
‚îÇ   ‚îú‚îÄ‚îÄ drizzle-neon-guard.mjs      # 4 online CI gates (MIG-DRZ-05a/b/c, MIG-DRZ-06)
‚îÇ   ‚îú‚îÄ‚îÄ run-migrate.mjs             # Migration runner (@neondatabase/serverless Pool)
‚îÇ   ‚îú‚îÄ‚îÄ patch-migration-triggers.mjs # NK immutability trigger patcher
‚îÇ   ‚îú‚îÄ‚îÄ validate-registry.ts
‚îÇ   ‚îú‚îÄ‚îÄ validate-migration-safety.ts
‚îÇ   ‚îú‚îÄ‚îÄ validate-gates.ts           # Master gate validator (16 gates)
‚îÇ   ‚îú‚îÄ‚îÄ validate-query-plans.ts
‚îÇ   ‚îî‚îÄ‚îÄ gates/                      # Individual gate implementations
‚îÇ       ‚îú‚îÄ‚îÄ fk-org-01.ts
‚îÇ       ‚îú‚îÄ‚îÄ money-01.ts
‚îÇ       ‚îú‚îÄ‚îÄ org-uuid-01.ts
‚îÇ       ‚îú‚îÄ‚îÄ pk-org-01.ts
‚îÇ       ‚îú‚îÄ‚îÄ prereq-01.ts            # Bootstrap prerequisites gate
‚îÇ       ‚îú‚îÄ‚îÄ reg-key-01.ts
‚îÇ       ‚îî‚îÄ‚îÄ rls-cast-01.ts          # auth.org_id()::uuid cast gate
‚îú‚îÄ‚îÄ drizzle/                  # Generated migrations
‚îú‚îÄ‚îÄ drizzle.config.ts         # Drizzle-kit config (walks up to find root .env)
‚îú‚îÄ‚îÄ drizzle.ci.config.ts      # Offline CI config (no DB credentials)
‚îú‚îÄ‚îÄ db.architecture.md        # Deep architecture reference (12 sections)
‚îú‚îÄ‚îÄ MIGRATION_GUIDE.md        # v2.6 ‚Üí v3.0 migration guide
‚îú‚îÄ‚îÄ EXAMPLE_CORRECT_SCHEMA.md # Canonical patterns for new tables
‚îî‚îÄ‚îÄ DATABASE_RESET_GUIDE.md   # Neon clean-deploy runbook
```

---

## Quick Start

### 1. DbSession ‚Äî the only way to touch the database

```typescript
import { createDbSession, contacts } from 'afenda-database';
import { eq } from 'drizzle-orm';

const session = createDbSession({
  orgId: '550e8400-e29b-41d4-a716-446655440000',
  userId: 'usr_abc123',
});

// Read (routes to replica; uses primary if session already wrote)
const rows = await session.ro((tx) =>
  tx.select().from(contacts).where(eq(contacts.orgId, orgId)).limit(50),
);

// Write (always primary; sets auth context as first statement)
const [created] = await session.rw((tx) =>
  tx.insert(contacts).values({ name: 'Acme Corp' }).returning(),
);
```

### 2. Worker sessions (BYPASSRLS)

```typescript
import { createWorkerSession } from 'afenda-database';

const ws = createWorkerSession('search-indexer');
await ws.rw((tx) => /* cross-org projection rebuild */);
```

### 3. Tagged queries for observability

```typescript
const data = await session.query('contacts.list', () =>
  session.ro((tx) => tx.select().from(contacts).limit(100)),
);
// Automatically logs slow queries (> shape threshold)
```

---

## Schema Conventions

### Table taxonomy (4-layer data model)

| Kind           | Count | Primary Key              | RLS | Updated triggers       | Examples                                      |
| -------------- | ----: | ------------------------ | --- | ---------------------- | --------------------------------------------- |
| **truth**      |    45 | composite `(org_id, id)` | yes | `set_updated_at`       | contacts, products, customers                 |
| **control**    |    24 | composite `(org_id, id)` | yes | `set_updated_at`       | workflow_rules, custom_fields, meta_assets    |
| **evidence**   |     6 | composite `(org_id, id)` | yes | **none** (append-only) | audit_logs, entity_versions, mutation_batches |
| **link**       |     4 | composite `(org_id, id)` | yes | **none**               | user_roles, role_permissions                  |
| **system**     |     6 | varies                   | yes | varies                 | users, roles, api_keys, r2_files              |
| **projection** |   0\* | ‚Äî                        | yes | **none**               | search_documents (created by workers)         |

_\* Projection tables are created at deploy-time by workers, not in the ORM schema._

### Column inheritance

```
baseEntityColumns          id, org_id, created_at, updated_at, created_by, updated_by, version, soft-delete
  ‚îî‚îÄ erpEntityColumns      + company_id, site_id, custom_data (JSONB)
       ‚îî‚îÄ docEntityColumns  + doc_status, submitted_at/by, cancelled_at/by, amended_from_id
```

### Creating a new table (canonical pattern)

```typescript
// src/schema/tax-rates.ts
import { pgTable, text, numeric, timestamp } from 'drizzle-orm/pg-core';
import { erpEntityColumns, tenantPk } from '../helpers/base-entity';
import { tenantPolicy } from '../helpers/tenant-policy';
import { sql } from 'drizzle-orm';
import { check, index } from 'drizzle-orm/pg-core';

export const taxRates = pgTable(
  'tax_rates',
  {
    ...erpEntityColumns,
    taxCode: text('tax_code').notNull(),
    rate: numeric('rate', { precision: 10, scale: 6 }).notNull(),
    effectiveFrom: timestamp('effective_from', { withTimezone: true }).notNull(),
  },
  (t) => [
    tenantPk(t),
    index('tax_rates_org_id_idx').on(t.orgId, t.id),
    index('tax_rates_org_created_idx').on(t.orgId, t.createdAt),
    check('tax_rates_org_not_empty', sql`org_id <> '00000000-0000-0000-0000-000000000000'::uuid`),
    tenantPolicy(t),
  ],
);

export type TaxRate = typeof taxRates.$inferSelect;
export type NewTaxRate = typeof taxRates.$inferInsert;
```

Or use the one-call `erpIndexes` helper to reduce boilerplate:

```typescript
import { erpEntityColumns } from '../helpers/base-entity';
import { erpIndexes } from '../helpers/standard-indexes';

export const taxRates = pgTable(
  'tax_rates',
  { ...erpEntityColumns, taxCode: text('tax_code').notNull() },
  (t) => [...erpIndexes('tax_rates', t)],
);
```

After creating the file:

1. Export from `src/schema/index.ts`
2. Register in `src/schema/_registry.ts`
3. `pnpm db:generate` ‚Üí creates migration
4. `pnpm db:migrate` ‚Üí applies migration

---

## Helpers Reference

### Column helpers (spread into `pgTable`)

| Helper              | Provides                                                                                  |
| ------------------- | ----------------------------------------------------------------------------------------- |
| `baseEntityColumns` | `id`, `orgId`, `createdAt`, `updatedAt`, `createdBy`, `updatedBy`, `version`, soft-delete |
| `erpEntityColumns`  | Above + `companyId`, `siteId`, `customData`                                               |
| `docEntityColumns`  | Above + `docStatus`, `submittedAt/By`, `cancelledAt/By`, `amendedFromId`                  |

### Field-type helpers

| Helper                     | DB type                     | Use case                                   |
| -------------------------- | --------------------------- | ------------------------------------------ |
| `moneyMinor(name)`         | `bigint` mode `'number'`    | Amounts in cents/sen                       |
| `currencyCode(name)`       | `text` default `'MYR'`      | ISO 4217 code (with default)               |
| `currencyCodeStrict(name)` | `text` NOT NULL, no default | ISO 4217 code (no silent default ‚Äî S4/S11) |
| `fxRate(name)`             | `numeric(20,10)`            | Exchange rate                              |
| `baseAmountMinor(name)`    | `bigint`                    | Base-currency amount                       |
| `qty(name)`                | `numeric(18,6)`             | Manufacturing quantity                     |
| `docNumber(name)`          | `text` NOT NULL             | Document numbers (`INV-00001`)             |
| `emailColumn(name)`        | `text`                      | Email addresses                            |
| `phoneColumn(name)`        | `text`                      | Phone numbers                              |
| `addressJsonb(name)`       | `jsonb`                     | Structured addresses                       |
| `tagsArray(name)`          | `text[]`                    | Tag arrays                                 |
| `statusColumn(name)`       | `text` NOT NULL             | Enum-style status                          |
| `companyRef()`             | `uuid`                      | FK to companies                            |
| `siteRef()`                | `uuid`                      | FK to sites                                |
| `contactRef(name)`         | `uuid`                      | FK to contacts                             |

### Tenant isolation helpers

| Helper                                  | Returns       | Use                                                       |
| --------------------------------------- | ------------- | --------------------------------------------------------- |
| `tenantPk(t)`                           | `primaryKey`  | Composite PK `(org_id, id)`                               |
| `tenantFk(t, name, col, parent)`        | `foreignKey`  | Composite FK `(org_id, col) ‚Üí (parent.org_id, parent.id)` |
| `tenantFkIndex(t, name, col)`           | `index`       | Index on `(org_id, col)` for FK lookups                   |
| `tenantFkPattern(t, name, col, parent)` | `{ fk, idx }` | FK + index combined                                       |
| `tenantPolicy(t)`                       | `crudPolicy`  | Standard tenant-isolation RLS                             |
| `ownerPolicy(t)`                        | `crudPolicy`  | Tenant + owner-level RLS                                  |
| `erpIndexes(tableName, t)`              | `array`       | PK + 2 indexes + CHECK + tenantPolicy                     |
| `docIndexes(tableName, t)`              | `array`       | erpIndexes + unique doc_no index                          |

---

## Public API (src/index.ts)

### Session & Auth

```typescript
createDbSession(ctx); // Create session with { orgId, userId }
createWorkerSession(name); // Worker session (BYPASSRLS)
isDbSession(value); // Type guard
setAuthContext(tx, org, user); // Manual auth context setting
validateAuthContext(org, user); // UUID format validation
withAuthContext(db, org, user, fn); // Transaction wrapper
```

### Observability

```typescript
QUERY_SHAPES; // Shape registry (17 hot-path shapes)
queryMonitor; // Slow-query logger
runQuery(shapeKey, n, fn); // Wrapped query execution
getQueryShapeStats(); // Shape summary
getHotPathShapes(); // Hot-path shapes for PLAN-01 gate
```

### Table Schemas (160 tables)

All 160 tables + inferred `Select` / `Insert` types are re-exported from `src/schema/index.ts`.

### Table Registry

```typescript
TABLE_REGISTRY; // Record<tableName, TableMetadata>
TAXONOMY_RULES; // Validation rules per kind
validateRegistry(); // Full registry validation
getTablesByKind(kind); // Filter tables by taxonomy
getTableMetadata(name); // Single table lookup
```

### DDL Helpers

```typescript
qIdent(id); // Safe SQL identifier quoting
qSchemaIdent(schema, id); // Schema-qualified quoting
columnList(cols); // Comma-separated quoted list
tenantPolicySql(table); // RLS policy SQL generation
standardRlsSetup(table); // Complete RLS setup SQL
evidenceRlsSetup(table); // Append-only RLS setup
projectionRlsSetup(table); // Worker-only-writes RLS
```

### Query Plan Analyzer

```typescript
validateQueryPlan(plan, opts); // Validate EXPLAIN JSON output
formatValidationResult(result); // Pretty-print validation
```

### Deprecated (removing in v3.0)

```typescript
db, dbRo, getDb            // Direct DB access ‚Üí use createDbSession()
eq, and, or, sql, ...      // Drizzle operators ‚Üí import from 'drizzle-orm'
```

---

## Scripts

```bash
# Build
pnpm build                        # tsup ‚Üí dist/
pnpm dev                          # Watch mode

# Quality
pnpm type-check                   # tsc --noEmit
pnpm lint                         # ESLint
pnpm lint:fix                     # ESLint auto-fix

# Drizzle-kit
pnpm db:generate                  # Generate migrations from schema
pnpm db:migrate                   # Apply migrations (programmatic runner, uses unpooled URL)
pnpm db:migrate:kit                # drizzle-kit CLI (may fail in monorepo)
pnpm db:studio                    # Drizzle Studio GUI
pnpm db:bootstrap                 # Bootstrap prerequisites (schemas, roles, auth)
pnpm db:check                     # Drizzle history consistency check

# Governance
pnpm db:lint                      # 8-rule schema linter
pnpm db:validate-registry         # Registry ‚Üî actual schema sync
pnpm db:validate-gates            # All CI gates
pnpm db:validate-migration        # Migration safety checks
pnpm db:validate-query-plans      # PLAN-01 hot-path validation

# Drizzle CI
pnpm db:drizzle:ci                # 8 offline gates (no DB needed)
pnpm db:drizzle:neon-guard        # 4 online gates (needs DATABASE_URL_MIGRATIONS)
pnpm db:patch-migration-triggers  # Append NK immutability triggers to newest migration
```

---

## Architecture Rules

### Rule 1 ‚Äî No business logic

Schemas define structure. Calculations, formatting, and orchestration live in Layer 2+ packages.

### Rule 2 ‚Äî No upward imports

```
‚úÖ  drizzle-orm, @neondatabase/serverless, Node built-ins
‚ùå  afenda-workflow, business-domain/*, afenda-crud
```

### Rule 3 ‚Äî Every tenant table has composite PK + RLS

No standalone `id` primary key on domain tables ‚Äî always `(org_id, id)` via `tenantPk(t)`.

### Rule 4 ‚Äî DbSession is the only entry point

Direct `db`/`dbRo` imports are deprecated. All new code must use `createDbSession()`.

### Rule 5 ‚Äî Migrations are forward-only

Generate ‚Üí review ‚Üí apply. No in-migration rollback logic. Create a separate forward migration to undo.

### Rule 6 ‚Äî NEVER use neon-http driver for migrations

neon-http has no transaction rollback. Use `neon-serverless`, `node-postgres`, or `postgres-js` (max: 1).

---

## Configuration

### Environment variables

```bash
# Required ‚Äî pooled connection (runtime queries)
DATABASE_URL=postgresql://user:pass@ep-xxx-pooler.region.aws.neon.tech/neondb?sslmode=require

# Required ‚Äî direct TCP connection (migrations & DDL)
DATABASE_URL_MIGRATIONS=postgresql://user:pass@ep-xxx.region.aws.neon.tech/neondb?sslmode=require

# Optional ‚Äî read-only replica (falls back to DATABASE_URL)
DATABASE_URL_RO=postgresql://user:pass@ep-xxx-ro-pooler.region.aws.neon.tech/neondb?sslmode=require
```

### Drizzle config

`drizzle.config.ts` walks up from `cwd` to find the monorepo root `.env` (up to 5 levels). This works regardless of whether you run from the package directory or the monorepo root.

```typescript
// drizzle.config.ts ‚Äî .env discovery pattern
let dir = process.cwd();
for (let i = 0; i < 5; i++) {
  const candidate = join(dir, '.env');
  if (existsSync(candidate)) {
    dotenv.config({ path: candidate });
    break;
  }
  dir = dirname(dir);
}
```

`drizzle.ci.config.ts` is used for offline CI gates ‚Äî no DB credentials needed.

---

## Related Documentation

| Document                                               | Description                                                             |
| ------------------------------------------------------ | ----------------------------------------------------------------------- |
| [db.architecture.md](db.architecture.md)               | Deep-dive: Neon integration, RLS, performance, migration management, DR |
| [MIGRATION_GUIDE.md](MIGRATION_GUIDE.md)               | Step-by-step v2.6 ‚Üí v3.0 DbSession migration                            |
| [EXAMPLE_CORRECT_SCHEMA.md](EXAMPLE_CORRECT_SCHEMA.md) | Canonical patterns: composite PK, composite FK, money columns           |
| [DATABASE_RESET_GUIDE.md](DATABASE_RESET_GUIDE.md)     | Neon clean-deploy runbook with verification checklist                   |
| [ARCHITECTURE.md](../../ARCHITECTURE.md)               | Monorepo-wide 4-layer architecture                                      |

---

**Last Updated:** 2026-02-21
**Architecture Version:** 3.1 (Canon DB Integration)
**Tables:** 160 ¬∑ **Helpers:** 9 files ¬∑ **CI Gates:** 8 offline + 4 online + 7 architectural
