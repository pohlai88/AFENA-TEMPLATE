<!-- AUTOGEN:START -->
<!-- Generated by afena readme gen — DO NOT EDIT inside this block -->
<!-- Signature: sha256:19d72e4df14736213bc467a48a7e1c124df305595b289efeea93a3d3a4904f47 -->
# afena-workflow

## Usage

```ts
import { /* ... */ } from 'afena-workflow';
```

## API

See source files for available exports.

## Installation

```bash
pnpm -w add afena-workflow
```

## Exports

| Subpath | Conditions |
|---|---|
| `.` | default: `./src/index.ts`, types: `./src/index.ts` |

## Scripts

| Script | Command |
|---|---|
| `build` | `tsup` |
| `dev` | `tsup --watch` |
| `lint` | `eslint . --ext .js,.jsx,.ts,.tsx --cache --concurrency=auto` |
| `lint:ci` | `eslint . --ext .js,.jsx,.ts,.tsx --rule 'import/no-cycle: error'` |
| `lint:fix` | `eslint . --ext .js,.jsx,.ts,.tsx --cache --fix` |
| `test` | `vitest run` |
| `type-check` | `tsc --noEmit` |

## Dependencies

| Package | Version |
|---|---|
| `afena-canon` | `workspace:*` |
| `afena-database` | `workspace:*` |
| `drizzle-orm` | `^0.44.0` |
| `zod` | `catalog:` |

## Related Packages

- `afena-canon`
- `afena-database`
- `afena-eslint-config`
- `afena-typescript-config`
- `afena-vitest-config`

<!-- AUTOGEN:END -->

# afena-workflow

Rule engine for before/after mutation hooks in the Afena Interaction Kernel.

## Public API

### Engine

- `evaluateRules(timing, spec, entity, ctx)` — evaluate all matching rules for a mutation

### Registry

- `registerRule(rule)` — register a workflow rule (sorted by priority)
- `unregisterRule(id)` — remove a rule by ID
- `getRegisteredRules()` — list all registered rules
- `clearRules()` — remove all rules

### Built-in Conditions

- `always` / `never` — constant matchers
- `fieldEquals(field, value)` — input field equality
- `fieldChanged(field)` — field differs from entity snapshot
- `actorHasRole(role)` — actor role check
- `allOf(...conds)` / `anyOf(...conds)` — AND/OR combinators

## Usage

```typescript
import { registerRule, fieldEquals } from 'afena-workflow';

registerRule({
  id: 'require-email',
  name: 'Require email on create',
  timing: 'before',
  entityTypes: ['contacts'],
  verbs: ['create'],
  priority: 50,
  enabled: true,
  condition: fieldEquals('email', undefined),
  action: () => ({ ok: false, message: 'Email is required' }),
});
```

## How It Works

- **Before-rules**: Can block or enrich mutations (runs inside `mutate()` before transaction)
- **After-rules**: Fire-and-forget side effects (runs after transaction commit, errors swallowed)

## Dependencies

`afena-canon`
