<!-- AUTOGEN:START -->
<!-- Generated by afenda readme gen â€” DO NOT EDIT inside this block -->
<!-- Signature: sha256:919a3686f39ab23f37dedb19dcfe605d4b2c31aa06f6ebee83c36fd1b80687c7 -->
# afenda-workflow

Package providing **main exports (barrel from index)**. Import from `afenda-workflow` in workspace packages.

## Package Overview

âœ… Has Tests â€¢ ğŸ“ 3 directory areas

### What's Inside

- **Main exports (barrel from index)**

### Directory Structure

```
â””â”€â”€ src/
    â”œâ”€â”€ __tests__/ (2 files)
    â””â”€â”€ v2/ â€” Versioned module (v2) (40 files)
```

### Source Layout

- **`v2/`** â€” Versioned module (v2)

### Entry Points

- `src/index.ts` â€” barrel export
- `src/v2/index.ts` â€” barrel export
- `src/v2/nodes/index.ts` â€” barrel export

## Usage

```ts
import { /* ... */ } from 'afenda-workflow';
```

This package exposes:

- Main exports (barrel from index)

## API

See `src/index.ts` and subpaths for full exports.

## Installation

```bash
pnpm -w add afenda-workflow
```

## Exports

| Subpath | Conditions |
|---|---|
| `.` | default: `./src/index.ts`, types: `./src/index.ts` |

## Scripts

| Script | Command |
|---|---|
| `build` | `tsup` |
| `dev` | `tsup --watch` |
| `lint` | `eslint . --ext .js,.jsx,.ts,.tsx --cache --concurrency=auto` |
| `lint:ci` | `eslint . --ext .js,.jsx,.ts,.tsx --rule 'import/no-cycle: error'` |
| `lint:fix` | `eslint . --ext .js,.jsx,.ts,.tsx --cache --fix` |
| `type-check` | `tsc --noEmit` |

## Architecture

Source is organized by responsibility. Key areas:

- **`src/v2/`** â€” Versioned module (v2)
- **`src/index.ts`** â€” Public API barrel

## Dependencies

| Package | Version |
|---|---|
| `afenda-canon` | `workspace:*` |
| `afenda-database` | `workspace:*` |
| `drizzle-orm` | `catalog:` |
| `zod` | `catalog:` |

## Related Packages

- `afenda-canon`
- `afenda-database`
- `afenda-eslint-config`
- `afenda-typescript-config`

## Contributing

### Development Workflow

1. Make changes to source files
2. Run `pnpm lint:fix` to fix linting issues
3. Run `pnpm type-check` to verify types
4. Run `pnpm test` to verify tests pass
5. Run `pnpm build` to verify build succeeds

### Code Quality

- All code must pass ESLint checks
- All code must pass TypeScript type checking
- All tests must pass
- Maintain or improve test coverage

<!-- AUTOGEN:END -->

# afenda-workflow

**Layer 2: Domain Services** â€¢ **Role:** Business Rules Engine

Rule engine for before/after mutation hooks with condition evaluation and action triggering.

---

## ğŸ“ Architecture Role

**Layer 2** in the 4-layer architecture:

```
Layer 3: Application (crud, observability)
Layer 2: Domain Services (workflow â† YOU ARE HERE, 116 business-domain packages)
Layer 1: Foundation (canon, database, logger, ui)
Layer 0: Configuration (eslint-config, typescript-config)
```

**Purpose:**
- Defines business rules as condition â†’ action mappings
- Evaluates rules before/after entity mutations
- Triggers actions (block, enrich, notify, log)

**Business Logic:** This package implements rule evaluation logic.

---

## âœ… What This Package Does

### 1. Rule Registry

```typescript
import { registerRule } from 'afenda-workflow';

registerRule({
  id: 'auto-approve-small-invoices',
  name: 'Auto-approve invoices under $10,000',
  timing: 'before',
  entityTypes: ['invoices'],
  verbs: ['create'],
  priority: 100,
  enabled: true,
  condition: fieldLessThan('totalMinor', 1000000), // $10,000 in cents
  action: (spec) => ({ ok: true, enrichments: { approved: true } }),
});
```

### 2. Rule Evaluation

```typescript
import { evaluateRules } from 'afenda-workflow';

const result = await evaluateRules('before', mutationSpec, entity, context);
if (!result.ok) {
  throw new Error(result.message);
}
```

### 3. Built-in Conditions

```typescript
import { fieldEquals, fieldChanged, actorHasRole, allOf, anyOf } from 'afenda-workflow';

// Field equality
fieldEquals('status', 'draft')

// Field changed from original
fieldChanged('totalMinor')

// Actor permission
actorHasRole('admin')

// Combinators
allOf(fieldEquals('status', 'draft'), actorHasRole('accountant'))
anyOf(actorHasRole('admin'), actorHasRole('accountant'))
```

---

## âŒ What This Package NEVER Does

| âŒ Never Do This | âœ… Do This Instead |
|-----------------|-------------------|
| Import from business-domain packages | Business domains can import workflow |
| Import from crud | CRUD calls workflow during mutations |
| Import from observability | Observability is upper layer |
| Implement database logic | Use database package for queries |

---

## ğŸ“¦ What This Package Exports

### Rule Engine

- `evaluateRules(timing, spec, entity, ctx)` â€” Evaluate all matching rules
- `registerRule(rule)` â€” Register a workflow rule
- `unregisterRule(id)` â€” Remove a rule by ID
- `getRegisteredRules()` â€” List all registered rules
- `clearRules()` â€” Remove all rules (testing only)

### Built-in Conditions

- `always()` / `never()` â€” Constant matchers
- `fieldEquals(field, value)` â€” Input field equality
- `fieldLessThan(field, value)` â€” Numeric comparison
- `fieldChanged(field)` â€” Field differs from entity snapshot
- `actorHasRole(role)` â€” Actor role check
- `allOf(...conditions)` â€” AND combinator
- `anyOf(...conditions)` â€” OR combinator

### Types

- `Rule` â€” Rule definition shape
- `RuleTiming` â€” 'before' | 'after'
- `RuleContext` â€” Evaluation context
- `RuleResult` â€” Evaluation result (ok, message, enrichments)

---

## ğŸ“– Usage Examples

### Before-Rule: Block Invalid Mutations

```typescript
import { registerRule, fieldEquals } from 'afenda-workflow';

registerRule({
  id: 'require-customer-email',
  name: 'Require email when creating customer',
  timing: 'before',
  entityTypes: ['customers'],
  verbs: ['create'],
  priority: 50,
  enabled: true,
  condition: fieldEquals('email', undefined),
  action: () => ({
    ok: false,
    message: 'Email is required for new customers',
  }),
});
```

### Before-Rule: Enrich Mutation

```typescript
registerRule({
  id: 'auto-set-created-date',
  name: 'Auto-set createdAt timestamp',
  timing: 'before',
  entityTypes: ['invoices'],
  verbs: ['create'],
  priority: 10,
  enabled: true,
  condition: always(),
  action: () => ({
    ok: true,
    enrichments: { createdAt: new Date() },
  }),
});
```

### After-Rule: Trigger Side Effect

```typescript
registerRule({
  id: 'notify-large-payment',
  name: 'Notify on payments over $100,000',
  timing: 'after',
  entityTypes: ['payments'],
  verbs: ['create'],
  priority: 100,
  enabled: true,
  condition: fieldGreaterThan('amountMinor', 10000000),
  action: async (spec, entity) => {
    await sendNotification('large-payment', { paymentId: entity.id });
    return { ok: true };
  },
});
```

---

## ğŸ”— Dependencies

### Workspace Dependencies

- âœ… `afenda-canon` (Layer 1) â€” imports types
- âœ… `afenda-database` (Layer 1) â€” queries database for rule data

### External Dependencies

- `drizzle-orm` â€” Database queries
- `zod` â€” Schema validation

### Who Depends on This Package

- âœ… `afenda-crud` (Layer 3) â€” calls `evaluateRules()` during mutations
- âœ… Business-domain packages (Layer 2) â€” MAY import if needed (same layer)

---

## ğŸš¦ Dependency Rules

```
âœ… ALLOWED:
  - afenda-canon (Layer 1)
  - afenda-database (Layer 1)
  - External npm (drizzle-orm, zod)
  - Node.js built-ins

âŒ FORBIDDEN:
  - business-domain/* (Layer 2, same layer - avoid coupling)
  - afenda-crud (Layer 3, upper layer)
  - afenda-observability (Layer 3, upper layer)
```

**Rule:** Layer 2 packages can depend on Layers 0 and 1, but NOT on other Layer 2 or Layer 3 packages.

---

## ğŸ“œ Scripts

```bash
pnpm build       # Build package
pnpm dev         # Watch mode
pnpm type-check  # TypeScript check
pnpm lint        # ESLint
pnpm lint:fix    # ESLint with auto-fix
pnpm test        # Run tests
```

---

## âš ï¸ PREVENT DRIFT - Critical Architecture Rules

### ğŸ”’ Rule 1: NEVER Import from Business Domains

**âŒ WRONG:**

```typescript
// src/index.ts
import { calculateTax } from 'afenda-accounting'; // FORBIDDEN!
```

**Why:** Workflow is Layer 2, same layer as business domains. No cross-domain dependencies.

**âœ… CORRECT:**

```typescript
// Workflow defines rules
// Business domains import workflow if they need rule evaluation
```

---

### ğŸ”’ Rule 2: Rules Are Data, Not Logic

**âŒ WRONG:**

```typescript
// Embedding complex logic in actions
action: async (spec, entity) => {
  const tax = spec.totalMinor * 0.0825; // TAX CALCULATION
  const total = spec.totalMinor + tax;
  // 50 lines of business logic...
}
```

**Why:** Complex logic belongs in business-domain packages, not in workflow rules.

**âœ… CORRECT:**

```typescript
// Keep actions simple: coordinate, don't calculate
import { calculateTax } from 'afenda-accounting';

action: async (spec, entity) => {
  const tax = calculateTax(spec.totalMinor, spec.taxRate);
  return { ok: true, enrichments: { taxMinor: tax } };
}
```

---

### ğŸ”’ Rule 3: Before-Rules Can Block, After-Rules Cannot

**âŒ WRONG:**

```typescript
registerRule({
  timing: 'after', // After mutation commits
  action: () => ({ ok: false, message: 'Blocked!' }), // âŒ Can't block!
});
```

**Why:** After-rules run after transaction commit. They can't block mutations.

**âœ… CORRECT:**

```typescript
// Before-rule: Can block
registerRule({
  timing: 'before',
  action: () => ({ ok: false, message: 'Validation failed' }),
});

// After-rule: Fire-and-forget only
registerRule({
  timing: 'after',
  action: async () => {
    await sendNotification(...);
    return { ok: true }; // Always ok, errors swallowed
  },
});
```

---

### ğŸ”’ Rule 4: NEVER Import from CRUD

**âŒ WRONG:**

```typescript
import { createInvoice } from 'afenda-crud'; // FORBIDDEN!
```

**Why:** Workflow is Layer 2, crud is Layer 3. Dependencies flow bottom-up only.

---

### ğŸš¨ Validation Commands

```bash
# Check for circular dependencies
pnpm run validate:deps

# Check for layer violations
pnpm lint:ci

# Type-check
pnpm type-check
```

---

## ğŸ” Quick Reference

| Question | Answer |
|----------|--------|
| **What layer?** | Layer 2 (Domain Services) |
| **What does it export?** | Rule engine, conditions, rule registry |
| **What does it import?** | canon (types), database (queries) |
| **Who imports it?** | crud (Layer 3), optionally business domains |
| **Can it import from domains?** | âŒ NO (same layer) |
| **Can it import from crud?** | âŒ NO (upper layer) |
| **Before vs After?** | Before = block/enrich, After = fire-and-forget |

---

## ğŸ“š Related Documentation

- [ARCHITECTURE.md](../../ARCHITECTURE.md) - Complete 4-layer architecture
- [packages/canon/README.md](../canon/README.md) - Type definitions
- [packages/crud/README.md](../crud/README.md) - Application orchestration

---

**Last Updated:** February 18, 2026  
**Architecture Version:** 2.0 (Clean State)
