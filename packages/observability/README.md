<!-- AUTOGEN:START -->
<!-- Generated by afenda readme gen ‚Äî DO NOT EDIT inside this block -->
<!-- Signature: sha256:e21662f584706c66f4a8bd6487ba40ae781f6b6d08e351ad8151b3d28b94a453 -->
# afenda-observability

OpenTelemetry instrumentation, metrics, and observability utilities for afenda

## Package Overview

üìÅ 1 directory areas

### What's Inside

- **Main exports (barrel from index)**

### Directory Structure

```
‚îî‚îÄ‚îÄ src/ (7 files)
```

### Entry Points

- `src/index.ts` ‚Äî barrel export

## Usage

```ts
import { /* ... */ } from 'afenda-observability';
```

This package exposes:

- Main exports (barrel from index)

## API

See `src/index.ts` and subpaths for full exports.

## Installation

```bash
pnpm -w add afenda-observability
```

## Exports

| Subpath | Conditions |
|---|---|
| `.` | import: `./dist/index.mjs`, require: `./dist/index.js`, types: `./dist/index.d.ts` |
| `./health` | import: `./dist/health.mjs`, require: `./dist/health.js`, types: `./dist/health.d.ts` |
| `./metrics` | import: `./dist/metrics.mjs`, require: `./dist/metrics.js`, types: `./dist/metrics.d.ts` |
| `./tracing` | import: `./dist/tracing.mjs`, require: `./dist/tracing.js`, types: `./dist/tracing.d.ts` |

## Scripts

| Script | Command |
|---|---|
| `build` | `tsup` |
| `clean` | `rm -rf dist .turbo node_modules` |
| `dev` | `tsup --watch` |
| `lint` | `eslint . --ext .js,.ts --cache` |
| `lint:fix` | `eslint . --ext .js,.ts --cache --fix` |
| `test` | `vitest run` |
| `test:coverage` | `vitest run --coverage` |
| `test:watch` | `vitest watch` |
| `type-check` | `tsc --noEmit` |

## Architecture

Source is organized by responsibility. Key areas:

- **`src/index.ts`** ‚Äî Public API barrel

## Testing

Run tests:

```bash
pnpm test
```

Watch mode:

```bash
pnpm test:watch
```

Coverage report:

```bash
pnpm test:coverage
```

## Dependencies

| Package | Version |
|---|---|
| `@opentelemetry/api` | `catalog:` |
| `@opentelemetry/auto-instrumentations-node` | `catalog:` |
| `@opentelemetry/exporter-metrics-otlp-http` | `catalog:` |
| `@opentelemetry/exporter-trace-otlp-http` | `catalog:` |
| `@opentelemetry/instrumentation` | `catalog:` |
| `@opentelemetry/resources` | `catalog:` |
| `@opentelemetry/sdk-node` | `catalog:` |
| `@opentelemetry/semantic-conventions` | `catalog:` |
| `@sentry/node` | `catalog:` |
| `afenda-logger` | `workspace:*` |

## Related Packages

- `afenda-eslint-config`
- `afenda-logger`
- `afenda-typescript-config`

## Contributing

### Development Workflow

1. Make changes to source files
2. Run `pnpm lint:fix` to fix linting issues
3. Run `pnpm type-check` to verify types
4. Run `pnpm test` to verify tests pass
5. Run `pnpm build` to verify build succeeds

### Code Quality

- All code must pass ESLint checks
- All code must pass TypeScript type checking
- All tests must pass
- Maintain or improve test coverage

<!-- AUTOGEN:END -->

# afenda-observability

**Layer 3: Application** ‚Ä¢ **Role:** Telemetry & Monitoring

OpenTelemetry tracing, metrics, health checks, and Sentry integration for AFENDA-NEXUS.

---

## üìê Architecture Role

**Layer 3** in the 4-layer architecture:

```
Layer 3: Application (crud, observability ‚Üê YOU ARE HERE)
Layer 2: Domain Services (workflow, advisory, 116 business-domain packages)
Layer 1: Foundation (canon, database, logger, ui)
Layer 0: Configuration (eslint-config, typescript-config)
```

**Purpose:**
- Provides distributed tracing (OpenTelemetry)
- Records metrics and KPIs
- Monitors health and liveness
- Integrates error tracking (Sentry)

**Observes, Does Not Control:** This package instruments but does not modify business logic.

---

## ‚úÖ What This Package Does

### 1. Distributed Tracing

```typescript
import { trace } from '@opentelemetry/api';
import { createSpan } from 'afenda-observability/tracing';

const tracer = trace.getTracer('my-service');

export async function processOrder(orderId: string) {
  return createSpan(tracer, 'process-order', async (span) => {
    span.setAttribute('order.id', orderId);
    const result = await database.processOrder(orderId);
    span.setAttribute('order.status', result.status);
    return result;
  });
}
```

### 2. Metrics & KPIs

```typescript
import { incrementCounter, recordMetric } from 'afenda-observability/metrics';

// Counter
incrementCounter('orders.processed', { status: 'success' });

// Histogram
recordMetric('order.processing.duration', 1250, { region: 'us-east-1' });

// Gauge
recordMetric('queue.size', 42, { queue: 'orders' });
```

### 3. Health Checks

```typescript
import { createHealthCheck } from 'afenda-observability/health';

export const healthCheck = createHealthCheck({
  name: 'afenda-web',
  checks: {
    database: async () => {
      const isHealthy = await db.ping();
      return { healthy: isHealthy };
    },
    cache: async () => {
      const isHealthy = await redis.ping();
      return { healthy: isHealthy };
    },
  },
});

// API route
export async function GET() {
  const health = await healthCheck.check();
  return Response.json(health, { status: health.healthy ? 200 : 503 });
}
```

### 4. Error Tracking (Sentry)

```typescript
import { initializeSentry } from 'afenda-observability';

initializeSentry({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1,
  profilesSampleRate: 0.1,
});
```

---

## ‚ùå What This Package NEVER Does

| ‚ùå Never Do This | ‚úÖ Do This Instead |
|-----------------|-------------------|
| Import from crud | Instrument crud externally |
| Implement business logic | Only instrument/observe |
| Modify data | Read-only observation |
| Import from business domains | Instrument domains externally |

---

## üì¶ What This Package Exports

### Tracing

- `initializeTracing(config)` ‚Äî Initialize OpenTelemetry SDK
- `createSpan(tracer, name, fn)` ‚Äî Create and auto-close span
- `getCurrentSpan()` ‚Äî Get active span from context
- `addSpanAttribute(key, value)` ‚Äî Add attribute to current span
- `withTracing(name, fn)` ‚Äî Higher-order function to wrap with tracing

### Metrics

- `incrementCounter(name, labels)` ‚Äî Increment counter metric
- `recordMetric(name, value, labels)` ‚Äî Record histogram/gauge
- `createMeter(name)` ‚Äî Create custom meter

### Health

- `createHealthCheck(config)` ‚Äî Create health check instance
- `registerHealthCheck(name, fn)` ‚Äî Register custom check

### Sentry

- `initializeSentry(config)` ‚Äî Initialize Sentry SDK
- `captureException(error, context)` ‚Äî Manually capture exceptions
- `captureMessage(message, level)` ‚Äî Capture messages

---

## üìñ Usage Examples

### Initialize OpenTelemetry

```typescript
// instrumentation.ts
import { initializeTracing } from 'afenda-observability/tracing';

export async function register() {
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    await initializeTracing({
      serviceName: 'afenda-web',
      serviceVersion: '0.1.0',
      environment: process.env.NODE_ENV || 'development',
      otlpEndpoint: process.env.OTEL_EXPORTER_OTLP_ENDPOINT,
    });
  }
}
```

### Trace API Route (Next.js)

```typescript
import { trace } from '@opentelemetry/api';
import { withTracing } from 'afenda-observability/tracing';

export const GET = withTracing('api.users.list', async (request) => {
  const span = trace.getActiveSpan();
  span?.setAttribute('http.route', '/api/users');

  const users = await db.query.users.findMany();
  return Response.json(users);
});
```

### Trace Database Queries

```typescript
import { traceQuery } from 'afenda-observability/tracing';

export async function findUser(id: string) {
  return traceQuery(
    'db.users.findById',
    async () => {
      return db.query.users.findFirst({ where: eq(users.id, id) });
    },
    {
      'db.operation': 'SELECT',
      'db.table': 'users',
      'user.id': id,
    },
  );
}
```

---

## üîó Dependencies

### Workspace Dependencies

**NONE** ‚Äî Layer 3 packages do not depend on each other.

### External Dependencies

- `@opentelemetry/api` ‚Äî OpenTelemetry API
- `@opentelemetry/sdk-node` ‚Äî OpenTelemetry SDK
- `@sentry/node` ‚Äî Sentry error tracking

### Who Depends on This Package

- ‚úÖ `apps/web` ‚Äî Instruments API routes
- ‚úÖ Background jobs ‚Äî Traces async tasks
- ‚úÖ CLI tools ‚Äî Monitors admin scripts

---

## üö¶ Dependency Rules

```
‚úÖ ALLOWED:
  - External npm (@opentelemetry/*, @sentry/*)
  - Node.js built-ins

‚ùå FORBIDDEN:
  - afenda-crud (Layer 3, same layer)
  - business-domain/* (Layer 2, lower layer)
  - afenda-workflow (Layer 2, lower layer)
  - afenda-database (Layer 1, creates coupling)
```

**Rule:** Layer 3 packages are isolated. They observe externally, not internally.

---

## üìú Scripts

```bash
pnpm build       # Build package
pnpm dev         # Watch mode
pnpm type-check  # TypeScript check
pnpm lint        # ESLint
pnpm lint:fix    # ESLint with auto-fix
```

---

## ‚ö†Ô∏è PREVENT DRIFT - Critical Architecture Rules

### üîí Rule 1: NEVER Import from CRUD

**‚ùå WRONG:**

```typescript
import { mutate } from 'afenda-crud'; // FORBIDDEN!
```

**Why:** Observability and CRUD are both Layer 3 (same layer). No cross-imports.

**‚úÖ CORRECT:**

```typescript
// Instrument CRUD externally in apps/web
import { mutate } from 'afenda-crud';
import { createSpan } from 'afenda-observability';

createSpan(tracer, 'mutate', async () => {
  return mutate(ctx, entityType, verb, input);
});
```

---

### üîí Rule 2: NEVER Import Business Logic

**‚ùå WRONG:**

```typescript
import { calculateTax } from 'afenda-accounting'; // FORBIDDEN!
```

**Why:** Observability is Layer 3, accounting is Layer 2. Coupling creates dependencies.

**‚úÖ CORRECT:**

```typescript
// Instrument accounting externally
import { calculateTax } from 'afenda-accounting';
import { createSpan } from 'afenda-observability';

createSpan(tracer, 'calculate-tax', async () => {
  return calculateTax(amount, rate);
});
```

---

### üîí Rule 3: Observe, Don't Modify

**‚ùå WRONG:**

```typescript
export function traceMutation(ctx, entityType, verb, input) {
  // ‚ùå Modifying input!
  input.tracedAt = new Date();
  return mutate(ctx, entityType, verb, input);
}
```

**Why:** Observability should be transparent, not invasive.

**‚úÖ CORRECT:**

```typescript
export function traceMutation(ctx, entityType, verb, input) {
  return createSpan(tracer, 'mutate', async (span) => {
    span.setAttribute('entity.type', entityType);
    span.setAttribute('mutation.verb', verb);
    // ‚úÖ Read-only observation
    return mutate(ctx, entityType, verb, input);
  });
}
```

---

### üîí Rule 4: Sample Smartly to Control Costs

**‚ùå WRONG:**

```typescript
// 100% sampling in production
await initializeTracing({
  serviceName: 'afenda-web',
  tracesSampleRate: 1.0, // ‚ùå Expensive!
});
```

**Why:** OTLP data costs money. Sample 10% in production, 100% in dev.

**‚úÖ CORRECT:**

```typescript
await initializeTracing({
  serviceName: 'afenda-web',
  tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
});
```

---

### üîí Rule 5: Always Close Spans

**‚ùå WRONG:**

```typescript
const span = tracer.startSpan('operation');
await performWork();
// ‚ùå Forgot to close span!
```

**Why:** Unclosed spans cause memory leaks.

**‚úÖ CORRECT:**

```typescript
const span = tracer.startSpan('operation');
try {
  await performWork();
} finally {
  span.end(); // ‚úÖ Always close
}

// Or use helper:
createSpan(tracer, 'operation', async (span) => {
  await performWork(); // Auto-closed
});
```

---

### üö® Validation Commands

```bash
# Type-check
pnpm type-check

# Lint
pnpm lint:ci

# Build
pnpm build
```

---

## üîç Quick Reference

| Question | Answer |
|----------|--------|
| **What layer?** | Layer 3 (Application) |
| **What does it export?** | Tracing, metrics, health checks, Sentry integration |
| **What does it import?** | Only external npm (OpenTelemetry, Sentry) |
| **Who imports it?** | apps/web, background jobs, CLI tools |
| **Can it import from crud?** | ‚ùå NO (same layer) |
| **Can it import from domains?** | ‚ùå NO (lower layer, creates coupling) |
| **Can it modify data?** | ‚ùå NO (observe only) |
| **What sample rate in prod?** | 10% (to control costs) |

---

## üìö Related Documentation

- [ARCHITECTURE.md](../../ARCHITECTURE.md) - Complete 4-layer architecture
- [packages/crud/README.md](../crud/README.md) - Application orchestration
- [OpenTelemetry Docs](https://opentelemetry.io/docs/) - Official OTEL docs
- [Sentry Node SDK](https://docs.sentry.io/platforms/node/) - Sentry docs

---

## Environment Variables

```bash
# OpenTelemetry
OTEL_EXPORTER_OTLP_ENDPOINT=https://ingest.lightstep.com:443
OTEL_EXPORTER_OTLP_HEADERS=lightstep-access-token=YOUR_TOKEN
OTEL_SERVICE_NAME=afenda-web
OTEL_SERVICE_VERSION=0.1.0
OTEL_TRACES_SAMPLER=parentbased_traceidratio
OTEL_TRACES_SAMPLER_ARG=0.1

# Sentry
SENTRY_DSN=https://...@sentry.io/...
SENTRY_ENVIRONMENT=production
SENTRY_TRACES_SAMPLE_RATE=0.1
SENTRY_PROFILES_SAMPLE_RATE=0.1

# Correlation
ENABLE_CORRELATION_IDS=true
CORRELATION_ID_HEADER=x-correlation-id
```

---

**Last Updated:** February 18, 2026  
**Architecture Version:** 2.0 (Clean State)

## Quick Start

### 1. Initialize OpenTelemetry (instrumentation.ts)

```typescript
import { initializeTracing } from 'afenda-observability/tracing';

export async function register() {
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    await initializeTracing({
      serviceName: 'afenda-web',
      serviceVersion: '0.1.0',
      environment: process.env.NODE_ENV || 'development',
      otlpEndpoint: process.env.OTEL_EXPORTER_OTLP_ENDPOINT,
    });
  }
}
```

### 2. Add Custom Spans

```typescript
import { trace } from '@opentelemetry/api';
import { createSpan } from 'afenda-observability/tracing';

const tracer = trace.getTracer('my-service');

export async function processOrder(orderId: string) {
  return createSpan(tracer, 'process-order', async (span) => {
    span.setAttribute('order.id', orderId);

    // Your business logic
    const result = await database.processOrder(orderId);

    span.setAttribute('order.status', result.status);
    return result;
  });
}
```

### 3. Record Custom Metrics

```typescript
import { incrementCounter, recordMetric } from 'afenda-observability/metrics';

// Counter
incrementCounter('orders.processed', { status: 'success' });

// Histogram
recordMetric('order.processing.duration', 1250, { region: 'us-east-1' });

// Gauge
recordMetric('queue.size', 42, { queue: 'orders' });
```

### 4. Health Checks

```typescript
import { createHealthCheck } from 'afenda-observability/health';

export const healthCheck = createHealthCheck({
  name: 'my-service',
  checks: {
    database: async () => {
      const isHealthy = await db.ping();
      return { healthy: isHealthy };
    },
    cache: async () => {
      const isHealthy = await redis.ping();
      return { healthy: isHealthy };
    },
  },
});

// In your API route
export async function GET() {
  const health = await healthCheck.check();
  return Response.json(health, { status: health.healthy ? 200 : 503 });
}
```

### 5. Sentry Integration

```typescript
import { initializeSentry } from 'afenda-observability';

initializeSentry({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1,
  profilesSampleRate: 0.1,
});
```

## Configuration

### Environment Variables

```bash
# OpenTelemetry
OTEL_EXPORTER_OTLP_ENDPOINT=https://ingest.lightstep.com:443
OTEL_EXPORTER_OTLP_HEADERS=lightstep-access-token=YOUR_TOKEN
OTEL_SERVICE_NAME=afenda-web
OTEL_SERVICE_VERSION=0.1.0
OTEL_TRACES_SAMPLER=parentbased_traceidratio
OTEL_TRACES_SAMPLER_ARG=0.1

# Sentry
SENTRY_DSN=https://...@sentry.io/...
SENTRY_ENVIRONMENT=production
SENTRY_TRACES_SAMPLE_RATE=0.1
SENTRY_PROFILES_SAMPLE_RATE=0.1

# Correlation
ENABLE_CORRELATION_IDS=true
CORRELATION_ID_HEADER=x-correlation-id
```

### Advanced Tracing

```typescript
import { context, SpanStatusCode, trace } from '@opentelemetry/api';

const tracer = trace.getTracer('advanced-service');

export async function complexOperation() {
  const span = tracer.startSpan('complex-operation');

  try {
    span.setAttribute('user.id', userId);
    span.addEvent('operation.started');

    const result = await performWork();

    span.setStatus({ code: SpanStatusCode.OK });
    return result;
  } catch (error) {
    span.recordException(error);
    span.setStatus({
      code: SpanStatusCode.ERROR,
      message: error.message,
    });
    throw error;
  } finally {
    span.end();
  }
}
```

## API Reference

### Tracing

- `initializeTracing(config)` - Initialize OpenTelemetry SDK
- `createSpan(tracer, name, fn)` - Create and auto-close span
- `getCurrentSpan()` - Get active span from context
- `addSpanAttribute(key, value)` - Add attribute to current span

### Metrics

- `incrementCounter(name, labels)` - Increment counter metric
- `recordMetric(name, value, labels)` - Record histogram/gauge
- `createMeter(name)` - Create custom meter

### Health

- `createHealthCheck(config)` - Create health check instance
- `registerHealthCheck(name, fn)` - Register custom check

## Best Practices

1. **Name Spans Consistently**: Use kebab-case: `user-login`, `order-process`
2. **Add Context**: Always add relevant attributes (user.id, entity.type)
3. **Sample Intelligently**: Use 10% sampling in production, 100% in dev
4. **Monitor Costs**: OTLP data can be expensive, tune sampling rates
5. **Correlation IDs**: Always propagate correlation IDs in headers

## Integration Examples

### Next.js API Route

```typescript
import { trace } from '@opentelemetry/api';
import { withTracing } from 'afenda-observability/tracing';

export const GET = withTracing('api.users.list', async (request) => {
  const span = trace.getActiveSpan();
  span?.setAttribute('http.route', '/api/users');

  const users = await db.query(...);
  return Response.json(users);
});
```

### Database Query Tracing

```typescript
import { traceQuery } from 'afenda-observability/tracing';

export async function findUser(id: string) {
  return traceQuery(
    'db.users.findById',
    async () => {
      return db.users.findById(id);
    },
    {
      'db.operation': 'SELECT',
      'db.table': 'users',
      'user.id': id,
    },
  );
}
```

## Troubleshooting

### No traces appearing

1. Check `OTEL_EXPORTER_OTLP_ENDPOINT` is set
2. Verify network connectivity to OTLP collector
3. Check sampling rate is > 0
4. Look for errors in logs

### High memory usage

1. Reduce sampling rate
2. Limit span attribute size
3. Check for span leaks (unclosed spans)

## Resources

- [OpenTelemetry Docs](https://opentelemetry.io/docs/)
- [Sentry Node SDK](https://docs.sentry.io/platforms/node/)
- [afenda Observability Guide](../../docs/OBSERVABILITY.md)

## License

MIT
