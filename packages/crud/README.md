<!-- AUTOGEN:START -->
<!-- Generated by afenda readme gen ‚Äî DO NOT EDIT inside this block -->
<!-- Signature: sha256:59449bd4d7fdef00555cadcbbc7ed24a97a876696deddd8db15af361639bc3cf -->

# afenda-crud

## Package Overview

‚úÖ Has Tests ‚Ä¢ üìÅ 4 Subdirectories

### What's Inside

- Configuration
- Main exports
- Services
- Type definitions

### Directory Structure

```
src/
‚îú‚îÄ‚îÄ __tests__/
‚îú‚îÄ‚îÄ handlers/
‚îú‚îÄ‚îÄ registries/
‚îî‚îÄ‚îÄ services/
```

### Entry Points

- `src/index.ts`

## Usage

```ts
import {/* ... */} from "afenda-crud";
```

## API

See source files for available exports.

## Installation

```bash
pnpm -w add afenda-crud
```

## Exports

| Subpath | Conditions                                         |
| ------- | -------------------------------------------------- |
| `.`     | default: `./src/index.ts`, types: `./src/index.ts` |

## Scripts

| Script       | Command                                                            |
| ------------ | ------------------------------------------------------------------ |
| `build`      | `tsup`                                                             |
| `dev`        | `tsup --watch`                                                     |
| `lint`       | `eslint . --ext .js,.jsx,.ts,.tsx --cache --concurrency=auto`      |
| `lint:ci`    | `eslint . --ext .js,.jsx,.ts,.tsx --rule 'import/no-cycle: error'` |
| `lint:fix`   | `eslint . --ext .js,.jsx,.ts,.tsx --cache --fix`                   |
| `test`       | `vitest run`                                                       |
| `type-check` | `tsc --noEmit`                                                     |

## Architecture

```
src/
‚îú‚îÄ‚îÄ services/   # Infrastructure services (custom fields, doc numbers, webhooks, etc.)
‚îî‚îÄ‚îÄ index.ts    # Public API (re-exports domain services from packages)
```

<!-- AUTOGEN:END -->

---

## Purpose

`afenda-crud` is the **Application Layer** orchestrator that provides:

- **Entity CRUD operations** with authorization, validation, and audit logging
- **Policy enforcement** (rate limiting, job quotas, metering)
- **Lifecycle management** (beforeCreate, afterUpdate, afterDelete hooks)
- **Domain service orchestration** (re-exports accounting, inventory, crm,
  intercompany services)

## When to Use This Package

Use `afenda-crud` for:

- Creating, reading, updating, deleting entities with built-in authorization
- Enforcing rate limits and job quotas
- Custom field validation and synchronization
- Document number allocation
- Webhook dispatch
- Accessing domain services (tax, pricing, inventory, accounting, etc.)

**Primary API:** `mutate()`, `readEntity()`, `listEntities()`

## Handler Architecture

The CRUD package uses a **registry pattern with sparse handlers**:

### Generic CRUD Path (209 of 211 entities)

Most entities use the **base handler** which provides:

- Schema validation (via `afenda-canon`)
- Authorization (via policy engine)
- Lifecycle hooks (create, update, delete)
- Audit logging
- Custom field support

### Custom Handlers (Only When Needed)

Custom handlers override specific behaviors for entities requiring:

- **Specialized validation** (e.g., company hierarchy checks)
- **Domain-specific business logic** (e.g., contact duplicate detection)
- **Complex relationships** (e.g., multi-entity cascading updates)

**Current Custom Handlers:**

- `companies`: Organization hierarchy validation
- `contacts`: Duplicate detection

**See:** [docs/HANDLER_GUIDE.md](docs/HANDLER_GUIDE.md) for detailed handler
creation guide.

## Domain Service Re-exports

CRUD re-exports domain services from specialized packages:

### Accounting Services

Tax calculation, FX lookup, depreciation, revenue recognition, payment
allocation, fiscal period management, bank reconciliation.

**Source:** `afenda-accounting`

### Inventory Services

UOM conversion, three-way matching, manufacturing BOM, lot recall, landed cost
allocation.

**Source:** `afenda-inventory`

### CRM Services

Pricing engine, discount evaluation, budget enforcement.

**Source:** `afenda-crm`

### Intercompany Services

IC transaction creation, matching, elimination entries, reconciliation.

**Source:** `afenda-intercompany`

## Infrastructure Services

CRUD maintains these infrastructure services (not moved to domain packages):

- **Custom field management**: Dynamic field validation and synchronization
- **Document numbering**: Sequential number allocation with fiscal year prefixes
- **Webhook dispatch**: Event-driven integrations
- **Search outbox**: Full-text search index maintenance
- **Workflow outbox**: Workflow rule evaluation queue

## Quick Start

### Mutate Entity

```typescript
import { buildSystemContext, mutate } from "afenda-crud";

const ctx = buildSystemContext(db, orgId);

const result = await mutate(
  ctx,
  "sales-orders",
  "create",
  {
    customerId: "cust-123",
    orderDate: "2024-01-15",
    items: [{ productId: "prod-456", quantity: 10 }],
  },
);
```

### Read Entity

```typescript
import { readEntity } from "afenda-crud";

const order = await readEntity(db, orgId, "sales-orders", orderId);
```

### Use Domain Services

```typescript
import { calculateLineTax, priceLineItem } from "afenda-crud";

// Tax calculation (from afenda-accounting)
const tax = await calculateLineTax(db, orgId, {
  taxRateId: "rate-123",
  baseAmountMinor: 10000,
});

// Pricing (from afenda-crm)
const pricing = await priceLineItem(db, orgId, {
  productId: "prod-456",
  customerId: "cust-123",
  quantity: 10,
});
```

## Testing

Run tests:

```bash
pnpm test
```

---

**See Also:**

- [ARCHITECTURE.md](../../ARCHITECTURE.md) - System architecture
- [docs/HANDLER_GUIDE.md](docs/HANDLER_GUIDE.md) - Custom handler creation guide
- [GOVERNANCE.md](../GOVERNANCE.md) - Dependency rules

## Dependencies

| Package           | Version       |
| ----------------- | ------------- |
| `afenda-canon`    | `workspace:*` |
| `afenda-database` | `workspace:*` |
| `afenda-logger`   | `workspace:*` |
| `afenda-workflow` | `workspace:*` |
| `drizzle-orm`     | `^0.44.0`     |
| `fast-json-patch` | `catalog:`    |
| `ioredis`         | `^5.4.1`      |

## Related Packages

- `afenda-canon`
- `afenda-database`
- `afenda-eslint-config`
- `afenda-logger`
- `afenda-typescript-config`
- `afenda-workflow`

## Contributing

### Development Workflow

1. Make changes to source files
2. Run `pnpm lint:fix` to fix linting issues
3. Run `pnpm type-check` to verify types
4. Run `pnpm test` to verify tests pass
5. Run `pnpm build` to verify build succeeds

### Code Quality

- All code must pass ESLint checks
- All code must pass TypeScript type checking
- All tests must pass
- Maintain or improve test coverage

<!-- AUTOGEN:END -->

# afenda-crud

The afenda Interaction Kernel (AIK) ‚Äî deterministic mutation ledger for all
domain data writes.

## Public API

Only 3 functions are exported (K-05):

- `mutate(spec, ctx)` ‚Äî the single entry point for all domain writes (create,
  update, delete, restore)
- `readEntity(type, id, ctx)` ‚Äî read a single entity by ID
- `listEntities(type, ctx, options)` ‚Äî list entities with filtering/pagination

## Usage

```typescript
import { mutate, readEntity } from "afenda-crud";

const receipt = await mutate({
  actionType: "contacts.create",
  entityRef: { type: "contacts" },
  input: { name: "Acme Corp", email: "hello@acme.com" },
}, ctx);
```

## Kernel Invariants

- **K-01**: `mutate()` is the only way to write domain data
- **K-02**: Single DB transaction per mutation
- **K-03**: Always writes `audit_logs` + `entity_versions`
- **K-04**: `expectedVersion` required on update/delete/restore
- **K-11**: Allowlist input + kernel backstop strips system columns

## Dependencies

`afenda-canon`, `afenda-database`, `afenda-logger`, `drizzle-orm`,
`fast-json-patch`
