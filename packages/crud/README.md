<!-- AUTOGEN:START -->
<!-- Generated by afenda readme gen â€” DO NOT EDIT inside this block -->
<!-- Signature: sha256:767b2b4e3715e685ed46452fe41602f5f6d9188cd0de5780bcd64ae22ac3f650 -->
# afenda-crud

Package providing **main exports (barrel from index)**. Import from `afenda-crud` in workspace packages.

## Package Overview

ğŸ“š Has Documentation â€¢ ğŸ“ 10 directory areas

### What's Inside

- **Main exports (barrel from index)**
- **Request or event handlers**
- **Services and business logic**

### Directory Structure

```
â”œâ”€â”€ src/
    â”œâ”€â”€ commit/ â€” Commit or apply logic (9 files)
    â”œâ”€â”€ deliver/ â€” Post-commit delivery effects (4 files)
    â”œâ”€â”€ handlers/ â€” Request or event handlers (4 files)
    â”œâ”€â”€ outbox/ â€” Outbox or queue writers (1 file)
    â”œâ”€â”€ plan/ â€” Planning or mutation plan logic (17 files)
    â”œâ”€â”€ registries/ (1 file)
    â”œâ”€â”€ services/ â€” Business logic and services (1 file)
    â””â”€â”€ util/ (3 files)
â””â”€â”€ docs/ â€” Documentation and guides (2 files)
```

### Source Layout

- **`commit/`** â€” Commit or apply logic
- **`deliver/`** â€” Post-commit delivery effects
- **`docs/`** â€” Documentation and guides
- **`handlers/`** â€” Request or event handlers
- **`outbox/`** â€” Outbox or queue writers
- **`plan/`** â€” Planning or mutation plan logic
- **`services/`** â€” Business logic and services

### Entry Points

- `src/index.ts` â€” barrel export

## Usage

```ts
import { /* ... */ } from 'afenda-crud';
```

This package exposes:

- Main exports (barrel from index)
- Request or event handlers
- Services and business logic

## API

See `src/index.ts` and subpaths for full exports.

## Installation

```bash
pnpm -w add afenda-crud
```

## Exports

| Subpath | Conditions |
|---|---|
| `.` | default: `./src/index.ts`, import: `./dist/index.mjs`, require: `./dist/index.js`, types: `./dist/index.d.ts` |
| `./internal` | default: `./src/internal.ts`, import: `./dist/internal.mjs`, require: `./dist/internal.js`, types: `./dist/internal.d.ts` |

## Scripts

| Script | Command |
|---|---|
| `build` | `tsup` |
| `dev` | `tsup --watch` |
| `lint` | `eslint . --ext .js,.jsx,.ts,.tsx --cache --concurrency=auto` |
| `lint:ci` | `eslint . --ext .js,.jsx,.ts,.tsx --rule 'import/no-cycle: error'` |
| `lint:fix` | `eslint . --ext .js,.jsx,.ts,.tsx --cache --fix` |
| `test` | `vitest run` |
| `type-check` | `tsc --noEmit` |

## Architecture

Source is organized by responsibility. Key areas:

- **`src/commit/`** â€” Commit or apply logic
- **`src/deliver/`** â€” Post-commit delivery effects
- **`src/handlers/`** â€” Request or event handlers
- **`src/outbox/`** â€” Outbox or queue writers
- **`src/plan/`** â€” Planning or mutation plan logic
- **`src/services/`** â€” Business logic and services
- **`docs/`** â€” Documentation and guides
- **`src/index.ts`** â€” Public API barrel

## Testing

Run tests:

```bash
pnpm test
```

## Dependencies

| Package | Version |
|---|---|
| `afenda-canon` | `workspace:*` |
| `afenda-database` | `workspace:*` |
| `afenda-logger` | `workspace:*` |
| `afenda-workflow` | `workspace:*` |
| `drizzle-orm` | `catalog:` |
| `fast-json-patch` | `catalog:` |
| `ioredis` | `catalog:` |

## Related Packages

- `afenda-canon`
- `afenda-database`
- `afenda-eslint-config`
- `afenda-logger`
- `afenda-typescript-config`
- `afenda-workflow`

## Contributing

### Development Workflow

1. Make changes to source files
2. Run `pnpm lint:fix` to fix linting issues
3. Run `pnpm type-check` to verify types
4. Run `pnpm test` to verify tests pass
5. Run `pnpm build` to verify build succeeds

### Code Quality

- All code must pass ESLint checks
- All code must pass TypeScript type checking
- All tests must pass
- Maintain or improve test coverage

<!-- AUTOGEN:END -->

# afenda-crud

> **Mutation Kernel (v1.1)** â€” Deterministic, auditable, policy-enforced entity lifecycle management

The CRUD package is the **single entry point** for all domain data writes in the Afena system. It orchestrates mutations through a 3-phase pipeline (Plan â†’ Commit â†’ Deliver) with built-in authorization, audit logging, versioning, and workflow integration.

---

## ğŸ“¦ Public API (K-05 Sealed)

Only **6 functions** and **5 types** are exported:

### Functions

```typescript
import { mutate, readEntity, listEntities } from 'afenda-crud';
import { buildSystemContext, buildUserContext } from 'afenda-crud';
import { setObservabilityHooks } from 'afenda-crud';
```

- **`mutate(spec, ctx)`** â€” Single entry point for all writes (create, update, delete, restore)
- **`readEntity(entityType, id, ctx)`** â€” Read single entity by ID
- **`listEntities(entityType, opts, ctx)`** â€” List entities with filtering/pagination
- **`buildSystemContext(orgId, userId)`** â€” Create system-level mutation context
- **`buildUserContext(params)`** â€” Create user-level mutation context with auth
- **`setObservabilityHooks(hooks)`** â€” Register observability callbacks

### Types

```typescript
import type { 
  MutationContext, 
  MutationSpec, 
  MutationReceipt,
  ApiResponse,
  ObservabilityHooks 
} from 'afenda-crud';
```

---

## ğŸš€ Quick Start

### Create Entity

```typescript
import { mutate, buildUserContext } from 'afenda-crud';

const ctx = buildUserContext({
  orgId: 'org-123',
  userId: 'user-456',
  userName: 'Alice',
  channel: 'web_ui',
});

const result = await mutate(
  {
    actionType: 'contacts.create',
    entityRef: { type: 'contacts', orgId: 'org-123' },
    input: {
      name: 'Acme Corp',
      email: 'hello@acme.com',
      phone: '+60123456789',
    },
  },
  ctx
);

if (result.ok) {
  console.log('Created:', result.data.entityId);
} else {
  console.error('Failed:', result.error.message);
}
```

### Update Entity

```typescript
const result = await mutate(
  {
    actionType: 'contacts.update',
    entityRef: { type: 'contacts', orgId: 'org-123', id: 'contact-789' },
    input: {
      expectedVersion: 3, // Optimistic concurrency control (K-04)
      email: 'new@acme.com',
    },
  },
  ctx
);
```

### Read Entity

```typescript
import { readEntity } from 'afenda-crud';

const contact = await readEntity('contacts', 'contact-789', ctx);
```

---

## ğŸ—ï¸ Architecture

### 3-Phase Pipeline (v1.1)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 1: PLAN (Reject-Fast)                                â”‚
â”‚  â”œâ”€ Validate input (Zod)                                    â”‚
â”‚  â”œâ”€ Enforce policy (authorization)                          â”‚
â”‚  â”œâ”€ Enforce lifecycle (state machine)                       â”‚
â”‚  â”œâ”€ Enforce field write rules (K-15)                        â”‚
â”‚  â”œâ”€ Run handler plan hooks                                  â”‚
â”‚  â””â”€ Build outbox intents                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 2: COMMIT (Single Transaction)                       â”‚
â”‚  â”œâ”€ Apply entity (INSERT/UPDATE/soft-delete/restore)        â”‚
â”‚  â”œâ”€ Write audit log (K-03)                                  â”‚
â”‚  â”œâ”€ Write version snapshot (K-03)                           â”‚
â”‚  â”œâ”€ Write outbox intents (K-12 atomic)                      â”‚
â”‚  â”œâ”€ Write idempotency record (K-10)                         â”‚
â”‚  â””â”€ Run handler commit hooks                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Phase 3: DELIVER (Best-Effort)                             â”‚
â”‚  â”œâ”€ Signal workers (workflow, search)                       â”‚
â”‚  â”œâ”€ Invalidate cache                                        â”‚
â”‚  â””â”€ Best-effort metering                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Directory Structure

```
src/
â”œâ”€â”€ index.ts              # K-05 sealed exports (6 functions + 5 types)
â”œâ”€â”€ mutate.ts             # Thin orchestrator (85 lines)
â”œâ”€â”€ read.ts               # Entity read operations
â”œâ”€â”€ context.ts            # Context builders
â”œâ”€â”€ observability-hooks.ts # Observability integration
â”‚
â”œâ”€â”€ plan/                 # Phase 1: Plan
â”‚   â”œâ”€â”€ build-plan.ts
â”‚   â”œâ”€â”€ validate-spec.ts
â”‚   â”œâ”€â”€ sanitize-input.ts
â”‚   â”œâ”€â”€ load-current.ts
â”‚   â”œâ”€â”€ enforce/
â”‚   â”‚   â”œâ”€â”€ policy.ts         # Authorization + CAPABILITY_CATALOG integration
â”‚   â”‚   â”œâ”€â”€ lifecycle.ts      # State machine
â”‚   â”‚   â”œâ”€â”€ field-write.ts    # K-15 FieldPolicyEngine
â”‚   â”‚   â”œâ”€â”€ edit-window.ts    # Workflow edit windows
â”‚   â”‚   â”œâ”€â”€ governor.ts       # Rate limiting
â”‚   â”‚   â””â”€â”€ rate-limiter.ts
â”‚   â”œâ”€â”€ validate/
â”‚   â”‚   â””â”€â”€ custom-fields.ts
â”‚   â””â”€â”€ outbox/
â”‚       â””â”€â”€ build-intents.ts
â”‚
â”œâ”€â”€ commit/               # Phase 2: Commit
â”‚   â”œâ”€â”€ commit-plan.ts
â”‚   â”œâ”€â”€ session.ts            # DbSession wrappers
â”‚   â”œâ”€â”€ apply-entity.ts       # Generic entity writer
â”‚   â”œâ”€â”€ write-audit.ts        # Audit log writer
â”‚   â”œâ”€â”€ write-version.ts      # Version snapshot writer
â”‚   â”œâ”€â”€ write-idempotency.ts  # K-10 idempotency
â”‚   â”œâ”€â”€ compute-diff.ts
â”‚   â”œâ”€â”€ allocate-doc-number.ts
â”‚   â””â”€â”€ sync-custom-fields.ts
â”‚
â”œâ”€â”€ deliver/              # Phase 3: Deliver
â”‚   â”œâ”€â”€ deliver-effects.ts
â”‚   â”œâ”€â”€ signal-workers.ts
â”‚   â”œâ”€â”€ invalidate-cache.ts
â”‚   â””â”€â”€ best-effort-metering.ts
â”‚
â”œâ”€â”€ handlers/             # Entity handlers
â”‚   â”œâ”€â”€ types.ts              # EntityHandlerV11 interface
â”‚   â”œâ”€â”€ base-handler.ts       # Generic handler (209 entities)
â”‚   â”œâ”€â”€ companies.ts          # Custom handler
â”‚   â””â”€â”€ contacts.ts           # Custom handler
â”‚
â”œâ”€â”€ registries/
â”‚   â””â”€â”€ handler-registry.ts
â”‚
â”œâ”€â”€ services/             # Infrastructure services
â”‚   â”œâ”€â”€ search-outbox.ts
â”‚   â””â”€â”€ (other services)
â”‚
â””â”€â”€ util/
    â”œâ”€â”€ cursor.ts
    â”œâ”€â”€ envelope.ts
    â””â”€â”€ stable-hash.ts
```

---

## ğŸ”’ Kernel Invariants (K-01 through K-15)

| ID | Invariant | Status |
|----|-----------|--------|
| K-01 | `mutate()` is the ONLY way to write domain data | âœ… Enforced by ESLint |
| K-02 | Single DB transaction per mutation | âœ… `withMutationTransaction()` |
| K-03 | Always writes `audit_logs` + `entity_versions` | âœ… `write-audit.ts` + `write-version.ts` |
| K-04 | `expectedVersion` required on update/delete/restore | âœ… Validated in `build-plan.ts` |
| K-05 | Exports ONLY 6 functions + 5 types | âœ… CI gate G-CRUD-01 |
| K-10 | Idempotency key for `*.create` only | âœ… `write-idempotency.ts` |
| K-11 | Allowlist input + kernel backstop strips system cols | âœ… `FieldPolicyEngine` |
| K-12 | Outbox writes are atomic with transaction | âœ… No try/catch, fails entire TX |
| K-15 | Field write policy enforcement | âœ… `enforceFieldWritePolicy()` |

---

## ğŸ“š Integration with Other Packages

### Infrastructure Services (via `afenda-crud/internal`)

```typescript
import { 
  allocateDocNumber,
  validateCustomFields,
  loadFieldDefs,
  checkRateLimit,
  meterApiRequest 
} from 'afenda-crud/internal';
```

**Note:** Infrastructure services are exported from the `/internal` sub-path, not the main barrel.

### Domain Services (import directly from domain packages)

```typescript
// âŒ WRONG: Don't import from crud
import { calculateTax } from 'afenda-crud';

// âœ… CORRECT: Import from domain package
import { calculateTax } from 'afenda-accounting';
import { priceLineItem } from 'afenda-crm';
import { convertUom } from 'afenda-inventory';
```

**Rule:** CRUD orchestrates, it does NOT implement business logic.

---

## ğŸ”§ Development

### Scripts

```bash
pnpm build       # Build package
pnpm dev         # Watch mode
pnpm type-check  # TypeScript check
pnpm lint        # ESLint
pnpm lint:fix    # ESLint with auto-fix
pnpm test        # Run tests
```

### Adding a New Entity Handler

Most entities use the **base handler** (no code needed). Only create a custom handler if you need:

- Specialized validation beyond schema
- Domain-specific business logic coordination
- Complex relationships or cascading updates

**Example:**

```typescript
// src/handlers/my-entity.ts
import type { EntityHandler } from './types';

export const myEntityHandler: EntityHandler = {
  entityType: 'my-entity',
  
  planCreate: async (ctx, input) => ({
    sanitizedInput: input,
    outboxIntents: [],
  }),
  
  commitAfterEntityWrite: async (tx, plan, written) => {
    // Optional: write subsidiary records
  },
};
```

Then register in `src/registries/handler-registry.ts`.

---

## ğŸ“– Related Documentation

- **[INTEGRATION_PLAN.md](./INTEGRATION_PLAN.md)** â€” v1.0 â†’ v1.1 migration plan (all 6 phases complete)
- **[crud.architecture.md](./crud.architecture.md)** â€” Detailed architecture documentation
- **[afenda-canon](../canon/README.md)** â€” Types, schemas, entity contracts
- **[afenda-database](../database/README.md)** â€” Schema, DbSession, RLS
- **[afenda-workflow](../workflow/README.md)** â€” Workflow engine integration

---

## âš ï¸ Critical Rules

### 1. NEVER Bypass `mutate()`

```typescript
// âŒ WRONG: Direct DB write
await db.insert(invoices).values({ ... });

// âœ… CORRECT: Use mutate()
await mutate({ actionType: 'invoices.create', ... }, ctx);
```

**Why:** Bypasses authorization, audit logging, workflow rules, versioning.

### 2. NEVER Import `db` or `dbRo` Directly

```typescript
// âŒ WRONG: Direct import
import { db } from 'afenda-database';

// âœ… CORRECT: Use DbSession wrappers
import { withMutationTransaction, withReadSession } from './commit/session';
```

**Enforced by:** CI gate G-CRUD-03 (scans all `src/` files)

### 3. NEVER Implement Business Logic in CRUD

```typescript
// âŒ WRONG: Tax calculation in CRUD
const taxMinor = input.subtotalMinor * 0.0825;

// âœ… CORRECT: Import from domain package
import { calculateTax } from 'afenda-accounting';
const taxMinor = await calculateTax(db, orgId, { ... });
```

---

## ğŸ¯ Version

**Current:** v1.1 (Phase 6 Complete)  
**Last Updated:** February 19, 2026

**Changelog:**
- âœ… Phase 1: Export seal + context builders
- âœ… Phase 2: Outbox intent model + idempotency
- âœ… Phase 2.5: Directory restructure
- âœ… Phase 3: MutationPlan + FieldPolicyEngine + handlers
- âœ… Phase 4: Thin orchestrator (85 lines)
- âœ… Phase 5: DbSession default-on + observability
- âœ… Phase 6: MutationReceipt discriminated union + CAPABILITY_CATALOG integration + handler metadata derivation

---

**License:** Private  
**Package:** `afenda-crud`  
**Type:** Application Orchestration (Layer 3)
