<!-- AUTOGEN:START -->
<!-- Generated by afenda readme gen ‚Äî DO NOT EDIT inside this block -->
<!-- Signature: sha256:6e0570adcc85dfa17f05fbe35117da1ef672d8a412bcb591438a22f5f1ef7705 -->
# afenda-canon

Package providing **capability or feature modules**. Import from `afenda-canon` in workspace packages.

## Package Overview

‚úÖ Has Tests ‚Ä¢ üìÅ 13 directory areas

### What's Inside

- **Capability or feature modules**
- **Domain logic and entities**
- **Main exports (barrel from index)**
- **React hooks**
- **Rule definitions and evaluators**
- **Type definitions and shared interfaces**
- **Utility functions**

### Directory Structure

```
‚îú‚îÄ‚îÄ src/
    ‚îú‚îÄ‚îÄ __tests__/ (3 files)
    ‚îú‚îÄ‚îÄ domain/ ‚Äî Domain logic and entities (5 files)
    ‚îú‚îÄ‚îÄ enums/ (26 files)
    ‚îú‚îÄ‚îÄ lite-meta/ (41 files)
    ‚îú‚îÄ‚îÄ mappings/ (16 files)
    ‚îú‚îÄ‚îÄ ports/ (7 files)
    ‚îú‚îÄ‚îÄ registries/ (19 files)
    ‚îú‚îÄ‚îÄ schemas/ (31 files)
    ‚îú‚îÄ‚îÄ types/ ‚Äî Type definitions and shared interfaces (39 files)
    ‚îú‚îÄ‚îÄ utils/ ‚Äî Utility functions (2 files)
    ‚îî‚îÄ‚îÄ validators/ (22 files)
‚îî‚îÄ‚îÄ scripts/ ‚Äî Build or runtime scripts (1 file)
```

### Source Layout

- **`domain/`** ‚Äî Domain logic and entities
- **`scripts/`** ‚Äî Build or runtime scripts
- **`types/`** ‚Äî Type definitions and shared interfaces
- **`utils/`** ‚Äî Utility functions

### Entry Points

- `src/domain/index.ts` ‚Äî barrel export
- `src/enums/index.ts` ‚Äî barrel export
- `src/index.ts` ‚Äî barrel export
- `src/lite-meta/adapters/index.ts` ‚Äî barrel export
- `src/lite-meta/batch/index.ts` ‚Äî barrel export
- `src/lite-meta/cache/index.ts` ‚Äî barrel export
- `src/lite-meta/core/index.ts` ‚Äî barrel export
- `src/lite-meta/hooks/index.ts` ‚Äî barrel export
- `src/lite-meta/index.ts` ‚Äî barrel export
- `src/lite-meta/resilience/index.ts` ‚Äî barrel export
- `src/lite-meta/types/index.ts` ‚Äî barrel export
- `src/mappings/index.ts` ‚Äî barrel export
- `src/ports/index.ts` ‚Äî barrel export
- `src/registries/index.ts` ‚Äî barrel export
- `src/schemas/catalog/index.ts` ‚Äî barrel export
- `src/schemas/index.ts` ‚Äî barrel export
- `src/types/capability/index.ts` ‚Äî barrel export
- `src/types/index.ts` ‚Äî barrel export
- `src/validators/core/index.ts` ‚Äî barrel export
- `src/validators/index.ts` ‚Äî barrel export
- `src/validators/presets/index.ts` ‚Äî barrel export
- `src/validators/rules/index.ts` ‚Äî barrel export

## Usage

```ts
import { /* ... */ } from 'afenda-canon';
```

This package exposes:

- Capability or feature modules
- Domain logic and entities
- Main exports (barrel from index)
- React hooks
- Rule definitions and evaluators
- Type definitions and shared interfaces
- Utility functions

## API

See `src/index.ts` and subpaths for full exports.

## Installation

```bash
pnpm -w add afenda-canon
```

## Exports

| Subpath | Conditions |
|---|---|
| `.` | import: `./dist/index.js`, require: `./dist/index.cjs`, types: `./dist/index.d.ts` |
| `./domain` | import: `./dist/domain/index.js`, require: `./dist/domain/index.cjs`, types: `./dist/domain/index.d.ts` |
| `./domain/finance` | import: `./dist/domain/finance.js`, require: `./dist/domain/finance.cjs`, types: `./dist/domain/finance.d.ts` |
| `./domain/hr` | import: `./dist/domain/hr.js`, require: `./dist/domain/hr.cjs`, types: `./dist/domain/hr.d.ts` |
| `./domain/manufacturing` | import: `./dist/domain/manufacturing.js`, require: `./dist/domain/manufacturing.cjs`, types: `./dist/domain/manufacturing.d.ts` |
| `./domain/supply-chain` | import: `./dist/domain/supply-chain.js`, require: `./dist/domain/supply-chain.cjs`, types: `./dist/domain/supply-chain.d.ts` |
| `./enums` | import: `./dist/enums/index.js`, require: `./dist/enums/index.cjs`, types: `./dist/enums/index.d.ts` |
| `./lite-meta` | import: `./dist/lite-meta/index.js`, require: `./dist/lite-meta/index.cjs`, types: `./dist/lite-meta/index.d.ts` |
| `./mappings` | import: `./dist/mappings/index.js`, require: `./dist/mappings/index.cjs`, types: `./dist/mappings/index.d.ts` |
| `./package.json` | default: `./package.json` |
| `./registries` | import: `./dist/registries/index.js`, require: `./dist/registries/index.cjs`, types: `./dist/registries/index.d.ts` |
| `./schemas` | import: `./dist/schemas/index.js`, require: `./dist/schemas/index.cjs`, types: `./dist/schemas/index.d.ts` |
| `./types` | import: `./dist/types/index.js`, require: `./dist/types/index.cjs`, types: `./dist/types/index.d.ts` |
| `./validators` | import: `./dist/validators/index.js`, require: `./dist/validators/index.cjs`, types: `./dist/validators/index.d.ts` |

## Scripts

| Script | Command |
|---|---|
| `build` | `tsup` |
| `dev` | `tsup --watch` |
| `lint` | `eslint . --ext .js,.jsx,.ts,.tsx --cache` |
| `lint:fix` | `eslint . --ext .js,.jsx,.ts,.tsx --fix` |
| `manifest` | `node scripts/generate-manifest.mjs` |
| `test` | `vitest run` |
| `test:coverage` | `vitest run --coverage` |
| `test:watch` | `vitest` |
| `type-check` | `tsc --noEmit` |

## Architecture

Source is organized by responsibility. Key areas:

- **`src/domain/`** ‚Äî Domain logic and entities
- **`src/types/`** ‚Äî Type definitions and shared interfaces
- **`src/utils/`** ‚Äî Utility functions
- **`scripts/`** ‚Äî Build or runtime scripts
- **`src/index.ts`** ‚Äî Public API barrel

## Testing

Run tests:

```bash
pnpm test
```

Watch mode:

```bash
pnpm test:watch
```

Coverage report:

```bash
pnpm test:coverage
```

## Dependencies

| Package | Version |
|---|---|
| `lru-cache` | `catalog:` |
| `zod` | `catalog:` |

## Related Packages

- `afenda-eslint-config`
- `afenda-typescript-config`

## Contributing

### Development Workflow

1. Make changes to source files
2. Run `pnpm lint:fix` to fix linting issues
3. Run `pnpm type-check` to verify types
4. Run `pnpm test` to verify tests pass
5. Run `pnpm build` to verify build succeeds

### Code Quality

- All code must pass ESLint checks
- All code must pass TypeScript type checking
- All tests must pass
- Maintain or improve test coverage

<!-- AUTOGEN:END -->

# afenda-canon

**Version:** 1.1.0 ‚Ä¢ **Status:** Production-Ready ‚úÖ  
**Layer 1: Foundation** ‚Ä¢ **Role:** Type System & Metadata Catalog

Single source of truth for ALL types, enums, Zod schemas, and metadata definitions across AFENDA-NEXUS.

---

## v1.1 Updates (2026-02-21)

- **`afenda-canon/domain`** ‚Äî New focused sub-path export for business-domain packages
- **Intent payload governance** ‚Äî All 37 finance packages type-check clean against canon payloads
- **Branded type helpers** ‚Äî Three-level `is*()` / `as*()` / `parse*()` for all domain branded types
- **Anti-bloat rules** ‚Äî Governance comments in barrel; sub-path exports documented

## v1.0 Production Status

**Shipped:** February 18, 2026  
**Tests:** 181/181 passing (100%)  
**TypeScript:** 0 errors  
**Coverage:** 44% overall (75-100% on core modules)  
**Dependencies:** `zod` + `lru-cache` only (zero workspace deps)

---

## üìê Architecture Role

**Layer 1** in the 4-layer architecture:

```
Layer 3: Application (crud, observability)
Layer 2: Domain Services (workflow, 116 business-domain packages)
Layer 1: Foundation (canon ‚Üê YOU ARE HERE, database, logger, ui)
Layer 0: Configuration (eslint-config, typescript-config)
```

**Purpose:**

- Exports types, enums, and Zod schemas
- Provides metadata catalog (LiteMetadata)
- Enforces ubiquitous language across all packages
- Prevents type duplication

**Zero Business Logic:** This package contains ONLY type definitions and pure functions.

---

## ‚úÖ What This Package Does

### 1. Exports TypeScript Types

```typescript
export interface Invoice {
  id: string;
  totalMinor: number; /* ... */
}
export interface Payment {
  id: string;
  invoiceId: string; /* ... */
}
export interface Customer {
  id: string;
  name: string; /* ... */
}
// 211+ entity types
```

### 2. Exports Enums

```typescript
export enum PaymentStatus {
  PENDING = 'pending',
  COMPLETED = 'completed',
}
export enum DocStatus {
  DRAFT = 'draft',
  FINAL = 'final',
}
// 50+ enums
```

### 3. Exports Zod Schemas

```typescript
export const invoiceSchema = z.object({ id: z.string(), totalMinor: z.number() });
export const paymentSchema = z.object({ id: z.string(), invoiceId: z.string() });
// 211+ validation schemas
```

### 4. LiteMetadata Catalog (NEW in v1.0)

```typescript
// Asset key system
import { buildAssetKey, parseAssetKey, validateAssetKey } from 'afenda-canon';

// Type mappings
import { POSTGRES_TO_CANON, mapPostgresType, TYPE_COMPAT_MATRIX } from 'afenda-canon';

// Classification
import { classifyColumn, PII_PATTERNS } from 'afenda-canon';

// Lineage & Quality
import { inferEdgeType, topoSortLineage, compileQualityRule } from 'afenda-canon';
```

---

## ‚ùå What This Package NEVER Does

| ‚ùå Never Do This                     | ‚úÖ Do This Instead                       |
| ------------------------------------ | ---------------------------------------- |
| Import from business-domain packages | Export types for domains to import       |
| Import from crud                     | Export types for crud to import          |
| Implement business logic             | Keep pure type definitions               |
| Implement database queries           | Export types for database package to use |
| Depend on workspace packages         | Only depend on external npm (Zod)        |

---

## üì¶ What This Package Exports

### Core Types

- **Entity Types:** `Invoice`, `Payment`, `Customer`, `TaxRate`, etc. (211+ types)
- **Base Types:** `BaseEntity`, `EntityRef`, `ActorRef`
- **Action Types:** `ActionType`, `ActionVerb`, `ActionFamily`
- **Mutation Types:** `MutationSpec`, `Receipt`, `ReceiptStatus`
- **API Types:** `ApiResponse`, `ErrorCode`, `KernelError`
- **Audit Types:** `AuditLogEntry`

### Enums

- `PaymentStatus`, `DocStatus`, `InvoiceStatus`, `OrderStatus` (50+ enums)

### Zod Schemas

- Every type has a matching Zod schema: `invoiceSchema`, `paymentSchema`, etc.

### Helpers

- `extractVerb(actionType)` ‚Äî Extract verb from `entity.verb`
- `extractEntityNamespace(actionType)` ‚Äî Extract entity name
- `getActionFamily(actionType)` ‚Äî Map action to CRUD/SAP family

---

## üìñ Usage Examples

### Import Types

```typescript
import type { Invoice, Payment, Customer } from 'afenda-canon';

function processInvoice(invoice: Invoice): void {
  // business logic uses canon types
}
```

### Import Enums

```typescript
import { PaymentStatus, DocStatus } from 'afenda-canon';

const status = PaymentStatus.COMPLETED;
```

### Import Schemas (Runtime Validation)

```typescript
import { invoiceSchema, type Invoice } from 'afenda-canon';

const validated: Invoice = invoiceSchema.parse(input);
```

### Schema Catalog

Canon exports a **static catalog** of all schemas for runtime discovery:

```typescript
import { CANON_SCHEMAS, getSchema, findSchemas, extractOpenApiSeeds } from 'afenda-canon';

// Get specific schema by ID
const entityIdSchema = getSchema('canon.branded.entityId');
if (entityIdSchema) {
  const result = entityIdSchema.schema.parse(uuid);
}

// Find all branded schemas
const branded = findSchemas({ category: 'branded' });

// Find all identifier schemas
const identifiers = findSchemas({ tags: ['identifier'] });

// Extract OpenAPI seeds (for Axis layer)
const seeds = extractOpenApiSeeds();
```

### Domain Sub-Path (Recommended for business-domain packages)

```typescript
// Shared types (all domain families)
import type { DomainContext, DomainResult } from 'afenda-canon/domain';
import { asCompanyId, stableCanonicalJson } from 'afenda-canon/domain';

// Finance-specific payloads + ports
import type { JournalPostPayload, LedgerControlPort } from 'afenda-canon/domain/finance';

// Future families:
// import type { PayrollRunPayload } from 'afenda-canon/domain/hr';
// import type { WorkOrderPayload } from 'afenda-canon/domain/manufacturing';
// import type { PurchaseOrderPayload } from 'afenda-canon/domain/supply-chain';
```

**Available sub-path exports:**

| Sub-path                            | Contents                                                                     | Use when...                                          |
| ----------------------------------- | ---------------------------------------------------------------------------- | ---------------------------------------------------- |
| `afenda-canon/domain`               | DomainContext, DomainResult, DomainError, branded types, stableCanonicalJson | Shared types needed by all domain families           |
| `afenda-canon/domain/finance`       | 70+ finance intent payloads, finance ports (LedgerControlPort, etc.)         | Writing finance domain services (37 packages)        |
| `afenda-canon/domain/supply-chain`  | Supply chain payloads + ports (stub)                                         | Writing supply chain services (14 packages planned)  |
| `afenda-canon/domain/hr`            | HR payloads + ports (stub)                                                   | Writing HR services (10 packages planned)            |
| `afenda-canon/domain/manufacturing` | Manufacturing payloads + ports (stub)                                        | Writing manufacturing services (12 packages planned) |
| `afenda-canon/schemas`              | Zod schemas                                                                  | Validating API input                                 |
| `afenda-canon/registries`           | Entity contracts, intent registry, taxonomy                                  | Building admin/meta tools                            |
| `afenda-canon/validators`           | Field validators                                                             | Custom field validation                              |
| `afenda-canon/lite-meta`            | Asset keys, lineage, quality rules                                           | Data catalog features                                |
| `afenda-canon/mappings`             | Postgres/CSV type mappings                                                   | Schema introspection                                 |
| `afenda-canon/enums`                | ERP enums                                                                    | UI dropdowns, status displays                        |
| `afenda-canon`                      | Everything (backward-compat)                                                 | When you need multiple categories                    |

### Entity Contract Registry

Access entity lifecycle contracts and metadata:

```typescript
import { ENTITY_CONTRACT_REGISTRY, getContract, findByVerb, findWithLifecycle } from 'afenda-canon';

// Get specific entity contract
const contract = getContract('invoices');
console.log(contract.label); // 'Invoice'
console.log(contract.hasLifecycle); // true

// Find all entities that support 'approve' action
const approvable = findByVerb('approve');

// Find all transactional documents
const transactional = findWithLifecycle();
```

---

## üîó Dependencies

### Workspace Dependencies

**NONE** ‚Äî This package has ZERO workspace dependencies.

### External Dependencies

- `zod` (validation schemas)

### Who Depends on This Package (v1.0 Verified)

- ‚úÖ `afenda-database` (Layer 1) ‚Äî imports types for schema definitions
- ‚úÖ `afenda-logger` (Layer 1) ‚Äî imports types for log context
- ‚úÖ `afenda-workflow` (Layer 2) ‚Äî imports types + LiteMetadata (verified)
- ‚úÖ `afenda-crud` (Layer 3) ‚Äî imports types + LiteMetadata for API handlers
- ‚úÖ `apps/web` (Layer 3) ‚Äî imports types for Next.js application
- ‚úÖ All 116 business-domain packages (Layer 2) ‚Äî import types for business logic

---

## üö¶ Dependency Rules

```
‚úÖ ALLOWED:
  - External npm packages (zod)
  - Node.js built-ins

‚ùå FORBIDDEN:
  - afenda-database (Layer 1, same layer)
  - afenda-workflow (Layer 2, upper layer)
  - business-domain/* (Layer 2, upper layer)
  - afenda-crud (Layer 3, upper layer)
```

**Rule:** Layer 1 packages can ONLY depend on Layer 0 + external npm.

---

## üõ†Ô∏è Development Workflow

### Adding a New Type

1. **Define the TypeScript type:**

```typescript
// src/types/accounting.ts
export interface TaxRate {
  taxCode: string;
  rate: number;
  effectiveFrom: Date;
}
```

2. **Create a Zod schema:**

```typescript
// src/schemas/accounting.ts
import { z } from 'zod';

export const taxRateSchema = z.object({
  taxCode: z.string(),
  rate: z.number(),
  effectiveFrom: z.date(),
});
```

3. **Export from index:**

```typescript
// src/index.ts
export type { TaxRate } from './types/accounting';
export { taxRateSchema } from './schemas/accounting';
```

4. **Use in other packages:**

```typescript
// business-domain/accounting/src/index.ts
import type { TaxRate } from 'afenda-canon';
import { taxRateSchema } from 'afenda-canon';
```

---

## üìú Scripts

```bash
pnpm build       # Build package
pnpm dev         # Watch mode
pnpm type-check  # TypeScript check
pnpm lint        # ESLint
pnpm lint:fix    # ESLint with auto-fix
```

---

## ‚ö†Ô∏è PREVENT DRIFT - Critical Architecture Rules

### üîí Rule 1: NEVER Import from Upper Layers

**‚ùå WRONG:**

```typescript
// src/index.ts
import { calculateTax } from 'afenda-accounting'; // FORBIDDEN!
```

**Why:** Canon is Layer 1, accounting is Layer 2. Dependencies flow bottom-up only.

**‚úÖ CORRECT:**

```typescript
// src/types/accounting.ts
export interface TaxRate {
  taxCode: string;
  rate: number;
}
```

---

### üîí Rule 2: NEVER Implement Business Logic

**‚ùå WRONG:**

```typescript
// src/types/invoice.ts
export interface Invoice {
  id: string;
  totalMinor: number;
}

// ‚ùå NO LOGIC!
export function calculateTotal(invoice: Invoice): number {
  return invoice.totalMinor;
}
```

**Why:** Canon contains ONLY types. Logic belongs in business-domain packages.

**‚úÖ CORRECT:**

```typescript
// afenda-canon: src/types/invoice.ts
export interface Invoice {
  id: string;
  totalMinor: number;
}

// afenda-accounting: src/services/invoice-calculation.ts
import type { Invoice } from 'afenda-canon';
export function calculateTotal(invoice: Invoice): number {
  return invoice.totalMinor;
}
```

---

### üîí Rule 3: NEVER Import from Same-Layer Packages

**‚ùå WRONG:**

```typescript
// src/index.ts
import { db } from 'afenda-database'; // FORBIDDEN! Same layer!
```

**Why:** Layer 1 packages cannot depend on each other. Only Layer 0 + external npm.

**‚úÖ CORRECT:**

```typescript
// afenda-canon exports types
// afenda-database imports canon types
// They don't cross-import
```

---

### üîí Rule 4: NEVER Export Functions (Except Pure Helpers)

**‚ùå WRONG:**

```typescript
export async function fetchInvoice(db, id) {
  /* ... */
} // FORBIDDEN!
```

**Why:** Canon is types-only. Functions belong in business-domain packages.

**‚úÖ ALLOWED (Pure Helpers Only):**

```typescript
// OK: Pure string manipulation, no dependencies
export function extractVerb(actionType: string): string {
  return actionType.split('.')[1] ?? '';
}
```

---

### üîí Rule 5: ALL Types Must Be Here

**‚ùå WRONG:**

```typescript
// business-domain/accounting/src/types.ts
export interface TaxRate {
  taxCode: string;
  rate: number;
} // WRONG LOCATION!
```

**Why:** Types belong in canon to prevent duplication and ensure consistency.

**‚úÖ CORRECT:**

```typescript
// afenda-canon: src/types/accounting.ts
export interface TaxRate {
  taxCode: string;
  rate: number;
}

// business-domain/accounting: src/index.ts
import type { TaxRate } from 'afenda-canon'; // Import from canon
```

---

### üö® Validation Commands

Run these to prevent drift:

```bash
# Check for circular dependencies
pnpm run validate:deps

# Check for layer violations
pnpm lint:ci

# Type-check
pnpm type-check

# Verify zero workspace dependencies
cat package.json | grep -A 5 dependencies
# Should only show: "zod"
```

---

## üîç Quick Reference

| Question                          | Answer                                           |
| --------------------------------- | ------------------------------------------------ |
| **What layer?**                   | Layer 1 (Foundation)                             |
| **What does it export?**          | Types, enums, Zod schemas                        |
| **What does it import?**          | Nothing from workspace (only Zod)                |
| **Who imports it?**               | All packages (database, workflow, domains, crud) |
| **Can it import from domains?**   | ‚ùå NO                                            |
| **Can it import from crud?**      | ‚ùå NO                                            |
| **Can it import from database?**  | ‚ùå NO (same layer)                               |
| **Can it have business logic?**   | ‚ùå NO (types only)                               |
| **Can it have database queries?** | ‚ùå NO (types only)                               |

---

## üìö Documentation

**In this package:**

- `README.md` (this file) - Quick start and usage guide
- `canon.architecture.md` - Complete architecture specification
- `src/*/README.md` - Detailed documentation for each subdirectory

**Related:**

- [ARCHITECTURE.md](../../ARCHITECTURE.md) - Complete 4-layer architecture
- [business-domain/AGENT.md](../../business-domain/AGENT.md) - Domain package agent rules
- [packages/database/README.md](../database/README.md) - Database schemas

---

**Version:** 1.1.0  
**Last Updated:** February 21, 2026  
**Status:** Production-Ready ‚úÖ
