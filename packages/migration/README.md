<!-- AUTOGEN:START -->
<!-- Generated by afenda readme gen â€” DO NOT EDIT inside this block -->
<!-- Signature: sha256:d3c7f784dfb7749fbb4ffed56a7384aaf629ebcc40ba1fca6f87d212449a1ae9 -->
# afenda-migration

Package providing **main exports (barrel from index)**. Import from `afenda-migration` in workspace packages.

## Package Overview

âœ… Has Tests â€¢ ğŸ“ 11 directory areas

### What's Inside

- **Main exports (barrel from index)**
- **Type definitions and shared interfaces**

### Directory Structure

```
â””â”€â”€ src/
    â”œâ”€â”€ __tests__/ (1 file)
    â”œâ”€â”€ adapters/ (6 files)
    â”œâ”€â”€ audit/ (3 files)
    â”œâ”€â”€ gates/ (3 files)
    â”œâ”€â”€ pipeline/ (10 files)
    â”œâ”€â”€ queries/ (2 files)
    â”œâ”€â”€ strategies/ (3 files)
    â”œâ”€â”€ transforms/ (2 files)
    â”œâ”€â”€ types/ â€” Type definitions and shared interfaces (10 files)
    â””â”€â”€ worker/ (3 files)
```

### Source Layout

- **`types/`** â€” Type definitions and shared interfaces

### Entry Points

- `src/adapters/index.ts` â€” barrel export
- `src/audit/index.ts` â€” barrel export
- `src/gates/index.ts` â€” barrel export
- `src/index.ts` â€” barrel export
- `src/pipeline/index.ts` â€” barrel export
- `src/queries/index.ts` â€” barrel export
- `src/strategies/index.ts` â€” barrel export
- `src/transforms/index.ts` â€” barrel export
- `src/types/index.ts` â€” barrel export
- `src/worker/index.ts` â€” barrel export

## Usage

```ts
import { /* ... */ } from 'afenda-migration';
```

This package exposes:

- Main exports (barrel from index)
- Type definitions and shared interfaces

## API

See `src/index.ts` and subpaths for full exports.

## Installation

```bash
pnpm -w add afenda-migration
```

## Exports

| Subpath | Conditions |
|---|---|
| `.` | import: `./dist/index.mjs`, require: `./dist/index.js`, types: `./dist/index.d.ts` |

## Scripts

| Script | Command |
|---|---|
| `build` | `tsup` |
| `dev` | `tsup --watch` |
| `lint` | `eslint . --ext .js,.jsx,.ts,.tsx --cache --concurrency=auto` |
| `lint:ci` | `eslint . --ext .js,.jsx,.ts,.tsx --cache --rule 'import/no-cycle: error'` |
| `lint:fix` | `eslint . --ext .js,.jsx,.ts,.tsx --cache --fix` |
| `type-check` | `tsc --noEmit` |

## Architecture

Source is organized by responsibility. Key areas:

- **`src/types/`** â€” Type definitions and shared interfaces
- **`src/index.ts`** â€” Public API barrel

## Dependencies

| Package | Version |
|---|---|
| `@neondatabase/serverless` | `catalog:` |
| `afenda-canon` | `workspace:*` |
| `afenda-database` | `workspace:*` |
| `afenda-logger` | `workspace:*` |
| `drizzle-orm` | `catalog:` |
| `fuse.js` | `catalog:` |
| `libphonenumber-js` | `catalog:` |
| `p-limit` | `catalog:` |
| `papaparse` | `catalog:` |

## Related Packages

- `afenda-canon`
- `afenda-database`
- `afenda-eslint-config`
- `afenda-logger`
- `afenda-typescript-config`

## Contributing

### Development Workflow

1. Make changes to source files
2. Run `pnpm lint:fix` to fix linting issues
3. Run `pnpm type-check` to verify types
4. Run `pnpm test` to verify tests pass
5. Run `pnpm build` to verify build succeeds

### Code Quality

- All code must pass ESLint checks
- All code must pass TypeScript type checking
- All tests must pass
- Maintain or improve test coverage

<!-- AUTOGEN:END -->

# afenda Migration Engine

Ratification-grade migration engine with atomicity guarantees, tightened SQL
contracts, canonized writable fields, and CI seal stamps.

## Architecture

### 2 Global Atomicity Decisions

**D0.1** â€” Reservation reclaim is single-statement atomic
(`UPDATE ... RETURNING`)\
**D0.2** â€” Delete reservation only by owned `lineageId`

### 4 Surgical Fixes

1. **Lineage State Machine** â€” Atomic winner semantics, no zombies,
   deterministic reclaim
2. **Structural Identifiers** â€” Legacy column validation, no drift between
   afenda/legacy schemas
3. **Entity-Agnostic Conflict Detection** â€” Strategy with `matchKeys`, total
   registry, auditable
4. **Canonized Write-Shape Snapshots** â€” Kernel-owned writable field lists, no
   invalid state leaks

### 4 CI Seal Stamps

- **RES-01:** No zombie reservations
- **SQL-02:** QueryBuilder rejects unknown legacy columns
- **DET-03:** ConflictDetector registry is total
- **SNAP-04:** Snapshot contains only writable fields

## Package Structure

```
packages/migration/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ types/           # Core types (Cursor, UpsertPlan, Query, etc.)
â”‚   â”œâ”€â”€ pipeline/        # Template Method pattern (MigrationPipelineBase)
â”‚   â”œâ”€â”€ adapters/        # Abstract Factory (SQL, CSV, API adapters)
â”‚   â”œâ”€â”€ strategies/      # Strategy pattern (ConflictDetector, ConflictStrategy)
â”‚   â”œâ”€â”€ transforms/      # Chain of Responsibility (TransformChain)
â”‚   â”œâ”€â”€ gates/           # Chain of Responsibility (PreflightGate, PostflightGate)
â”‚   â”œâ”€â”€ decorators/      # Decorator pattern (TimeoutAdapter, MetricsAdapter)
â”‚   â”œâ”€â”€ commands/        # Command pattern (RunMigrationBatchCommand)
â”‚   â”œâ”€â”€ builders/        # Builder pattern (MigrationJobBuilder)
â”‚   â”œâ”€â”€ worker/          # Graphile Worker integration
â”‚   â”œâ”€â”€ audit/           # Canonical JSON hashing, signed reports
â”‚   â””â”€â”€ __tests__/       # CI seal stamp tests
â”‚       â””â”€â”€ invariants/
â””â”€â”€ package.json
```

## Implementation Status

- [x] Package structure created
- [x] Core types defined
- [x] Pipeline base with atomic reservations (Fix 1)
- [ ] Structural QueryBuilder (Fix 2)
- [ ] Entity-agnostic conflict detection (Fix 3)
- [ ] Canonized write-shape snapshots (Fix 4)
- [ ] CI seal stamp tests
- [ ] Database schema migration
- [ ] Dependencies wired

## Usage

```typescript
import { MigrationPipelineBase } from 'afenda-migration/pipeline';
import { getConflictDetector } from 'afenda-migration/strategies';

// Implement concrete pipeline
class SqlMigrationPipeline extends MigrationPipelineBase {
  // ... implementation
}

// Run migration
const pipeline = new SqlMigrationPipeline(job, context);
const result = await pipeline.run();
```

## Dependencies

- `afenda-canon` â€” Entity types, canonized field lists
- `afenda-crud` â€” Mutate kernel
- `afenda-database` â€” Drizzle schema, DB connection
- `afenda-logger` â€” Pino logging
- `graphile-worker` â€” Background job processing
- `pg` â€” PostgreSQL client

## Testing

```bash
pnpm test                    # All tests
pnpm test:invariants         # CI seal stamps only
```

## License

Private
