<!-- AUTOGEN:START -->
<!-- Generated by afena readme gen â€” DO NOT EDIT inside this block -->
<!-- Signature: sha256:b595d32ebc9f3d496d3fc55c9274a0630a8182f8dedf783c78f1e62b2e5149e5 -->
# afena-migration

## Package Overview

ğŸ“ 9 Subdirectories

### What's Inside

- Configuration
- Main exports
- Type definitions

### Directory Structure

```
src/
â”œâ”€â”€ adapters/
â”œâ”€â”€ audit/
â”œâ”€â”€ gates/
â”œâ”€â”€ pipeline/
â”œâ”€â”€ queries/
â”œâ”€â”€ strategies/
â”œâ”€â”€ transforms/
â”œâ”€â”€ types/
â””â”€â”€ worker/
```

### Entry Points

- `src/adapters/index.ts`
- `src/audit/index.ts`
- `src/gates/index.ts`
- `src/index.ts`
- `src/pipeline/index.ts`
- `src/queries/index.ts`
- `src/strategies/index.ts`
- `src/transforms/index.ts`
- `src/types/index.ts`
- `src/worker/index.ts`

## Usage

```ts
import { /* ... */ } from 'afena-migration';
```

## API

See source files for available exports.

## Installation

```bash
pnpm -w add afena-migration
```

## Exports

| Subpath | Conditions |
|---|---|
| `.` | import: `./dist/index.mjs`, require: `./dist/index.js`, types: `./dist/index.d.ts` |

## Scripts

| Script | Command |
|---|---|
| `build` | `tsup` |
| `dev` | `tsup --watch` |
| `lint` | `eslint . --ext .js,.jsx,.ts,.tsx --cache --concurrency=auto` |
| `lint:ci` | `eslint . --ext .js,.jsx,.ts,.tsx --rule 'import/no-cycle: error'` |
| `lint:fix` | `eslint . --ext .js,.jsx,.ts,.tsx --cache --fix` |
| `type-check` | `tsc --noEmit` |

## Architecture

```
src/
â”œâ”€â”€ types/      # Type definitions
â””â”€â”€ index.ts    # Public API
```

## Dependencies

| Package | Version |
|---|---|
| `@neondatabase/serverless` | `^1.0.0` |
| `afena-canon` | `workspace:*` |
| `afena-database` | `workspace:*` |
| `afena-logger` | `workspace:*` |
| `drizzle-orm` | `^0.44.0` |
| `fuse.js` | `^7.1.0` |
| `libphonenumber-js` | `^1.12.36` |
| `p-limit` | `^7.3.0` |
| `papaparse` | `^5.5.3` |

## Related Packages

- `afena-canon`
- `afena-database`
- `afena-eslint-config`
- `afena-logger`
- `afena-typescript-config`

## Contributing

### Development Workflow

1. Make changes to source files
2. Run `pnpm lint:fix` to fix linting issues
3. Run `pnpm type-check` to verify types
4. Run `pnpm test` to verify tests pass
5. Run `pnpm build` to verify build succeeds

### Code Quality

- All code must pass ESLint checks
- All code must pass TypeScript type checking
- All tests must pass
- Maintain or improve test coverage

<!-- AUTOGEN:END -->

# Afena Migration Engine

Ratification-grade migration engine with atomicity guarantees, tightened SQL contracts, canonized writable fields, and CI seal stamps.

## Architecture

### 2 Global Atomicity Decisions

**D0.1** â€” Reservation reclaim is single-statement atomic (`UPDATE ... RETURNING`)  
**D0.2** â€” Delete reservation only by owned `lineageId`

### 4 Surgical Fixes

1. **Lineage State Machine** â€” Atomic winner semantics, no zombies, deterministic reclaim
2. **Structural Identifiers** â€” Legacy column validation, no drift between Afena/legacy schemas
3. **Entity-Agnostic Conflict Detection** â€” Strategy with `matchKeys`, total registry, auditable
4. **Canonized Write-Shape Snapshots** â€” Kernel-owned writable field lists, no invalid state leaks

### 4 CI Seal Stamps

- **RES-01:** No zombie reservations
- **SQL-02:** QueryBuilder rejects unknown legacy columns
- **DET-03:** ConflictDetector registry is total
- **SNAP-04:** Snapshot contains only writable fields

## Package Structure

```
packages/migration/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ types/           # Core types (Cursor, UpsertPlan, Query, etc.)
â”‚   â”œâ”€â”€ pipeline/        # Template Method pattern (MigrationPipelineBase)
â”‚   â”œâ”€â”€ adapters/        # Abstract Factory (SQL, CSV, API adapters)
â”‚   â”œâ”€â”€ strategies/      # Strategy pattern (ConflictDetector, ConflictStrategy)
â”‚   â”œâ”€â”€ transforms/      # Chain of Responsibility (TransformChain)
â”‚   â”œâ”€â”€ gates/           # Chain of Responsibility (PreflightGate, PostflightGate)
â”‚   â”œâ”€â”€ decorators/      # Decorator pattern (TimeoutAdapter, MetricsAdapter)
â”‚   â”œâ”€â”€ commands/        # Command pattern (RunMigrationBatchCommand)
â”‚   â”œâ”€â”€ builders/        # Builder pattern (MigrationJobBuilder)
â”‚   â”œâ”€â”€ worker/          # Graphile Worker integration
â”‚   â”œâ”€â”€ audit/           # Canonical JSON hashing, signed reports
â”‚   â””â”€â”€ __tests__/       # CI seal stamp tests
â”‚       â””â”€â”€ invariants/
â””â”€â”€ package.json
```

## Implementation Status

- [x] Package structure created
- [x] Core types defined
- [x] Pipeline base with atomic reservations (Fix 1)
- [ ] Structural QueryBuilder (Fix 2)
- [ ] Entity-agnostic conflict detection (Fix 3)
- [ ] Canonized write-shape snapshots (Fix 4)
- [ ] CI seal stamp tests
- [ ] Database schema migration
- [ ] Dependencies wired

## Usage

```typescript
import { MigrationPipelineBase } from 'afena-migration/pipeline';
import { getConflictDetector } from 'afena-migration/strategies';

// Implement concrete pipeline
class SqlMigrationPipeline extends MigrationPipelineBase {
  // ... implementation
}

// Run migration
const pipeline = new SqlMigrationPipeline(job, context);
const result = await pipeline.run();
```

## Dependencies

- `afena-canon` â€” Entity types, canonized field lists
- `afena-crud` â€” Mutate kernel
- `afena-database` â€” Drizzle schema, DB connection
- `afena-logger` â€” Pino logging
- `graphile-worker` â€” Background job processing
- `pg` â€” PostgreSQL client

## Testing

```bash
pnpm test                    # All tests
pnpm test:invariants         # CI seal stamps only
```

## License

Private
