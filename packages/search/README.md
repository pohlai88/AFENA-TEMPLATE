<!-- AUTOGEN:START -->
<!-- Generated by afena readme gen — DO NOT EDIT inside this block -->
<!-- Signature: sha256:fe54eecf67b341885656a74972f3a19c24e13e2710aef1d4c5d76a7c94b9f5fa -->
# afena-search

## Usage

```ts
import { /* ... */ } from 'afena-search';
```

## API

See source files for available exports.

## Installation

```bash
pnpm -w add afena-search
```

## Exports

| Subpath | Conditions |
|---|---|
| `.` | default: `./src/index.ts`, types: `./src/index.ts` |

## Scripts

| Script | Command |
|---|---|
| `build` | `tsup` |
| `dev` | `tsup --watch` |
| `lint` | `eslint . --ext .js,.jsx,.ts,.tsx --cache --concurrency=auto` |
| `lint:ci` | `eslint . --ext .js,.jsx,.ts,.tsx --rule 'import/no-cycle: error'` |
| `lint:fix` | `eslint . --ext .js,.jsx,.ts,.tsx --cache --fix` |
| `test` | `vitest run` |
| `type-check` | `tsc --noEmit` |

## Dependencies

| Package | Version |
|---|---|
| `afena-database` | `workspace:^` |
| `drizzle-orm` | `^0.44.0` |

## Related Packages

- `afena-database`
- `afena-eslint-config`
- `afena-typescript-config`
- `afena-vitest-config`

<!-- AUTOGEN:END -->

# afena-search

Full-text search helpers and cross-entity search registry for the Afena platform.

## Public API

### FTS Helpers

- `toTsQuery(query)` — convert user input to PostgreSQL tsquery
- `ftsWhere(column, query)` — generate tsvector WHERE clause
- `ftsRank(column, query)` — generate ts_rank ORDER BY
- `ilikeFallback(columns, query)` — ILIKE fallback for non-FTS columns

### Registry

- `registerSearchableEntity(config)` — register an entity type for cross-entity search
- `getRegisteredEntityTypes()` — list registered entity types
- `crossEntitySearch(query, options)` — fan-out search across all registered entities

### Adapters

- `searchContacts(query, options)` — contacts-specific search adapter (ILIKE)

## Usage

```typescript
import { crossEntitySearch, registerSearchableEntity } from 'afena-search';

registerSearchableEntity({ type: 'contacts', adapter: searchContacts });
const results = await crossEntitySearch('acme', { limit: 10 });
```

## GAP-DB-004: Incremental Search (Vercel)

Search uses `search_documents` + `search_outbox`. On Vercel:

- **Cron** (every 5 min): `GET /api/internal/search/drain` — self-healing backfill + drain
- **Poke** (after mutation): `after()` fires `POST /api/internal/search/drain` for near-real-time updates
- **Env**: `CRON_SECRET` (required for drain), `VERCEL_URL` or `NEXT_PUBLIC_APP_URL` (for poke)
- **DB**: Use worker role (BYPASSRLS) for drain so it can process all orgs

## Dependencies

`afena-database`, `drizzle-orm`, `afena-logger`
