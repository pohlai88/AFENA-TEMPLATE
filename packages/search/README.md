<!-- AUTOGEN:START -->
<!-- Generated by afenda readme gen ‚Äî DO NOT EDIT inside this block -->
<!-- Signature: sha256:8b2eb3db19d9e00992d5733c5b2f9a4a5525a05cad2e4dacc5c02c00caa754c9 -->

# afenda-search

## Package Overview

üìÅ 2 Subdirectories

### What's Inside

- Configuration
- Main exports
- Type definitions

### Directory Structure

```
src/
‚îú‚îÄ‚îÄ adapters/
‚îî‚îÄ‚îÄ worker/
```

### Entry Points

- `src/index.ts`

## Usage

```ts
import {/* ... */} from "afenda-search";
```

## API

See source files for available exports.

## Installation

```bash
pnpm -w add afenda-search
```

## Exports

| Subpath | Conditions                                         |
| ------- | -------------------------------------------------- |
| `.`     | default: `./src/index.ts`, types: `./src/index.ts` |

## Scripts

| Script       | Command                                                            |
| ------------ | ------------------------------------------------------------------ |
| `build`      | `tsup`                                                             |
| `dev`        | `tsup --watch`                                                     |
| `lint`       | `eslint . --ext .js,.jsx,.ts,.tsx --cache --concurrency=auto`      |
| `lint:ci`    | `eslint . --ext .js,.jsx,.ts,.tsx --rule 'import/no-cycle: error'` |
| `lint:fix`   | `eslint . --ext .js,.jsx,.ts,.tsx --cache --fix`                   |
| `type-check` | `tsc --noEmit`                                                     |

## Architecture

```
src/
‚îî‚îÄ‚îÄ index.ts    # Public API
```

## Dependencies

| Package           | Version       |
| ----------------- | ------------- |
| `afenda-database` | `workspace:^` |
| `afenda-logger`   | `workspace:*` |
| `drizzle-orm`     | `^0.44.0`     |

## Related Packages

- `afenda-database`
- `afenda-eslint-config`
- `afenda-logger`
- `afenda-typescript-config`

## Contributing

### Development Workflow

1. Make changes to source files
2. Run `pnpm lint:fix` to fix linting issues
3. Run `pnpm type-check` to verify types
4. Run `pnpm test` to verify tests pass
5. Run `pnpm build` to verify build succeeds

### Code Quality

- All code must pass ESLint checks
- All code must pass TypeScript type checking
- All tests must pass
- Maintain or improve test coverage

<!-- AUTOGEN:END -->

# afenda-search

Full-text search helpers and cross-entity search registry for the afenda
platform.

## Public API

### FTS Helpers

- `toTsQuery(query)` ‚Äî convert user input to PostgreSQL tsquery
- `ftsWhere(column, query)` ‚Äî generate tsvector WHERE clause
- `ftsRank(column, query)` ‚Äî generate ts_rank ORDER BY
- `ilikeFallback(columns, query)` ‚Äî ILIKE fallback for non-FTS columns

### Registry

- `registerSearchableEntity(config)` ‚Äî register an entity type for cross-entity
  search
- `getRegisteredEntityTypes()` ‚Äî list registered entity types
- `crossEntitySearch(query, options)` ‚Äî fan-out search across all registered
  entities

### Adapters

- `searchContacts(query, options)` ‚Äî contacts-specific search adapter (ILIKE)

## Usage

```typescript
import { crossEntitySearch, registerSearchableEntity } from "afenda-search";

registerSearchableEntity({ type: "contacts", adapter: searchContacts });
const results = await crossEntitySearch("acme", { limit: 10 });
```

## GAP-DB-004: Incremental Search (Vercel)

Search uses `search_documents` + `search_outbox`. On Vercel:

- **Cron** (every 5 min): `GET /api/internal/search/drain` ‚Äî self-healing
  backfill + drain
- **Poke** (after mutation): `after()` fires `POST /api/internal/search/drain`
  for near-real-time updates
- **Env**: `CRON_SECRET` (required for drain), `VERCEL_URL` or
  `NEXT_PUBLIC_APP_URL` (for poke)
- **DB**: Use worker role (BYPASSRLS) for drain so it can process all orgs

## Dependencies

`afenda-database`, `drizzle-orm`, `afenda-logger`
