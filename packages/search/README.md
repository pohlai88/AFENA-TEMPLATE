<!-- AUTOGEN:START -->
<!-- Generated by afenda readme gen â€” DO NOT EDIT inside this block -->
<!-- Signature: sha256:06608e6c749abae85806d0a79c3e700d1e0cfa2f5ed594484c7aa192816dba74 -->
# afenda-search

Package providing **main exports (barrel from index)**. Import from `afenda-search` in workspace packages.

## Package Overview

âœ… Has Tests â€¢ ğŸ“ 4 directory areas

### What's Inside

- **Main exports (barrel from index)**

### Directory Structure

```
â””â”€â”€ src/
    â”œâ”€â”€ __tests__/ (1 file)
    â”œâ”€â”€ adapters/ (3 files)
    â””â”€â”€ worker/ (1 file)
```

### Entry Points

- `src/index.ts` â€” barrel export

## Usage

```ts
import { /* ... */ } from 'afenda-search';
```

This package exposes:

- Main exports (barrel from index)

## API

See `src/index.ts` and subpaths for full exports.

## Installation

```bash
pnpm -w add afenda-search
```

## Exports

| Subpath | Conditions |
|---|---|
| `.` | default: `./src/index.ts`, types: `./src/index.ts` |

## Scripts

| Script | Command |
|---|---|
| `build` | `tsup` |
| `dev` | `tsup --watch` |
| `lint` | `eslint . --ext .js,.jsx,.ts,.tsx --cache --concurrency=auto` |
| `lint:ci` | `eslint . --ext .js,.jsx,.ts,.tsx --rule 'import/no-cycle: error'` |
| `lint:fix` | `eslint . --ext .js,.jsx,.ts,.tsx --cache --fix` |
| `type-check` | `tsc --noEmit` |

## Architecture

Source is organized by responsibility. Key areas:

- **`src/index.ts`** â€” Public API barrel

## Dependencies

| Package | Version |
|---|---|
| `afenda-database` | `workspace:^` |
| `afenda-logger` | `workspace:*` |
| `drizzle-orm` | `catalog:` |

## Related Packages

- `afenda-database`
- `afenda-eslint-config`
- `afenda-logger`
- `afenda-typescript-config`

## Contributing

### Development Workflow

1. Make changes to source files
2. Run `pnpm lint:fix` to fix linting issues
3. Run `pnpm type-check` to verify types
4. Run `pnpm test` to verify tests pass
5. Run `pnpm build` to verify build succeeds

### Code Quality

- All code must pass ESLint checks
- All code must pass TypeScript type checking
- All tests must pass
- Maintain or improve test coverage

<!-- AUTOGEN:END -->

# afenda-search

Full-text search helpers and cross-entity search registry for the afenda
platform.

## Public API

### FTS Helpers

- `toTsQuery(query)` â€” convert user input to PostgreSQL tsquery
- `ftsWhere(column, query)` â€” generate tsvector WHERE clause
- `ftsRank(column, query)` â€” generate ts_rank ORDER BY
- `ilikeFallback(columns, query)` â€” ILIKE fallback for non-FTS columns

### Registry

- `registerSearchableEntity(config)` â€” register an entity type for cross-entity
  search
- `getRegisteredEntityTypes()` â€” list registered entity types
- `crossEntitySearch(query, options)` â€” fan-out search across all registered
  entities

### Adapters

- `searchContacts(query, options)` â€” contacts-specific search adapter (ILIKE)

## Usage

```typescript
import { crossEntitySearch, registerSearchableEntity } from 'afenda-search';

registerSearchableEntity({ type: 'contacts', adapter: searchContacts });
const results = await crossEntitySearch('acme', { limit: 10 });
```

## GAP-DB-004: Incremental Search (Vercel)

Search uses `search_documents` + `search_outbox`. On Vercel:

- **Cron** (every 5 min): `GET /api/internal/search/drain` â€” self-healing
  backfill + drain
- **Poke** (after mutation): `after()` fires `POST /api/internal/search/drain`
  for near-real-time updates
- **Env**: `CRON_SECRET` (required for drain), `VERCEL_URL` or
  `NEXT_PUBLIC_APP_URL` (for poke)
- **DB**: Use worker role (BYPASSRLS) for drain so it can process all orgs

## Dependencies

`afenda-database`, `drizzle-orm`, `afenda-logger`
